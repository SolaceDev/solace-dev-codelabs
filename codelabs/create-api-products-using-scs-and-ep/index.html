
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Creating Event API Products using Spring Cloud Stream, Event Portal and AsyncAPI</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="create-api-products-using-scs-and-ep"
                  title="Creating Event API Products using Spring Cloud Stream, Event Portal and AsyncAPI"
                  environment="web"
                  feedback-link="https://github.com/SolaceDev/solace-dev-codelabs/blob/master/markdown/create-api-products-using-scs-and-ep">
    
      <google-codelab-step label="Overview" duration="1">
        <p>If your requirement is to build modern, real-time applications using event-driven architecture (EDA), this codelab will walk you through the steps of how to build Event API products, define asynchronous APIs, implement them using Spring Cloud Stream microservices, and globally distribute them across multi-cloud and on-premises environments using an Solace PubSub+ platform.</p>
<p>In this codelab, we will create API Products that helps others to consume Business capabilities of a <em>SmartTown</em> where APIs are a way of life. We will also</p>
<ul>
<li>Learn how to define asynchronous APIs.</li>
<li>Use the AsyncAPI Generator template for Spring Cloud Stream.</li>
<li>Develop event-driven microservices using Spring Cloud Stream and Java.</li>
<li>Connect your microservices to PubSub+ Event Brokers and stream events across the globe</li>
</ul>
<p>Prerequisites</p>
<ul>
<li>Intermediate level of knowledge coding with Java</li>
<li>Computer with internet connectivity</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Requirements" duration="1">
        <p>ðŸ›  This page covers the setup needed to perform this codelab. ðŸ› </p>
<h2 is-upgraded>PubSub+ Event Broker</h2>
<p>âœ… You need to sign for a free Solace Cloud Account using <a href="https://console.solace.cloud/login/new-account" target="_blank">this link</a>.</p>
<aside class="special"><p>Note that no credit card is required. You will receive an email to activate the account and will then be prompted to start the free trail.</p>
</aside>
<p>Complete the following steps:</p>
<ol type="1">
<li><strong>Log into the PubSub+ Cloud Console</strong>  To start using PubSub+ Cloud, log in to the PubSub+ Cloud Console. For more information on accessing the Cloud Console, check out the <a href="https://docs.solace.com/Solace-Cloud/ggs_login.htm" target="_blank">documentation</a></li>
<li><strong>Create an Event Broker Service</strong> Create an event broker service (or simply a service) using Cluster Manager tool and name the service as <code>solace-eap</code>. For more information on accessing the Cloud Console, check out the <a href="https://docs.solace.com/Solace-Cloud/ggs_create_first_service.htm" target="_blank">documentation</a></li>
<li><strong>Create a Client Username</strong> Connect to the broker service and open the Message VPN console to add client username under <code>Access Control</code> setting. Create a client username <code>smarttown</code> with password <code>smarttown</code>.</li>
</ol>
<p>Ensure that you have captured the following details on connection information that will be used in this codelab.</p>
<ul>
<li>SMF Host: <code>tcp://xxxxxx.messaging.solace.cloud:55555</code></li>
<li>Message VPN: solace-eap</li>
<li>Username: <code>smarttown</code></li>
<li>Password: <code>smarttown</code></li>
</ul>
<h2 is-upgraded>AsyncAPI Generator Requirements</h2>
<p>âœ… Install instructions available <a href="https://github.com/asyncapi/generator#requirements" target="_blank">here</a></p>
<ul>
<li>Node.js v12.16+ (Check version using <code>node -v</code>)</li>
<li>npm v6.13.7+ (Check version using <code>npm -version</code>)</li>
</ul>
<h2 is-upgraded>Spring Cloud Stream Requirements</h2>
<p>âœ… Spring Cloud Stream just requires Java and Maven to use ðŸš€</p>
<ul>
<li>Java 1.8+ (Check version using <code>java -version</code>)</li>
<li>Maven 3.3+ (Check version using <code>mvn -version</code>)  <ul>
<li>On mac you can <code>brew install maven</code></li>
<li>Other install instructions <a href="https://maven.apache.org/install.html" target="_blank">here</a></li>
</ul>
</li>
<li>Your favorite Java IDE ðŸ’¥</li>
</ul>
<h2 is-upgraded>Clone Git Repository</h2>
<p>A ready to use code of few of the microservices referred in this workshop are available in Git. We will use this codebase and build new code wherever necessary to complete this workshop.</p>
<aside class="special"><p>Also, the completed solution is available in a branch (solution) on the same repository.</p>
</aside>
<ul>
<li>Launch Terminal application</li>
<li>Execute the following command <br><code>cd ~/github<br>git clone https://github.com/gvensan/smarttown.git<br></code></li>
</ul>
<p>This would create a directory by name <strong>smarttown</strong> and checkout the git repository contents.   <img src="img/43a3b8686a6a3b71.jpg"></p>


      </google-codelab-step>
    
      <google-codelab-step label="PubSub&#43; Event Portal" duration="3">
        <h2 is-upgraded>Solace PubSub+ Event Portal</h2>
<p>The Market&#39;s First API Portal...for Events</p>
<p><a href="https://solace.com/blog/api-portal-for-events/" target="_blank">PubSub+ Event Portal</a> lets you design your event-driven applications, events, and schemas as interconnected network diagrams your team can go over in design reviews.</p>
<p>With the PubSub+ Event Portal, you can:</p>
<ul>
<li>Define and model event-driven systems</li>
<li>Visualize existing relationships</li>
<li>Develop consistent event-driven applications</li>
<li>Discover and share events of interest</li>
<li>Govern the event-driven system</li>
<li>Integrate with 3rd-party systems for programmatic interactions</li>
<li>Manage and audit changes to events, schemas, and applications</li>
<li>Runtime event discovery</li>
<li>Understand statistics about events</li>
</ul>
<p class="image-container"><img src="img/90589fcb7e51e18b.jpg"></p>
<h2 is-upgraded>Foundational Elements of PubSub+ Event Portal</h2>
<p class="image-container"><img src="img/a15d4f8e4514c9e3.jpg"></p>
<h3 is-upgraded>Application Domain</h3>
<p>An application domain represents a namespace where applications, events, and schemas can live. Application domains are useful to decompose the enterprise and create organizational boundaries within which teams can work. Within the application domain, you can create a suite of applications, events and schemas that are isolated from other application domains.</p>
<h3 is-upgraded>Schema</h3>
<p>In simple terms, a schema represents the contract to describe the payload of an event. Producers and consumers of an event can trust that the event&#39;s payload matches the schema definition assigned to that event. Schemas define a type of payload through JSON, AVRO, XML, Binary, or Text. JSON, AVRO, and XML schemas have content that describes each property of the schema. The content is either in JSON or AVRO Schema format, or XSD/DTD format.</p>
<h3 is-upgraded>Event</h3>
<p>The event represents a business moment or an action that can be communicated with zero or more interested applications. The event is where you define metadata that describes and categorizes the event. An event is produced on a specific topic that must be defined for that event. From a modelling perspective, events reference payload schemas, and events are referenced by applications, thus forming the glue that binds applications together.</p>
<h3 is-upgraded>Application</h3>
<p>An application represents a piece of software that produces and consumes events. Applications connect to the event broker in an event-driven architecture and communicate with other applications via events. A single application represents a class of applications that are running the same code base; therefore, there is no need to create multiple applications for each instance in a cluster.</p>
<p>Icons used in Designer: <img src="img/665668c2bd8341d8.jpg"></p>


      </google-codelab-step>
    
      <google-codelab-step label="SmartTown - Event-Driven Design" duration="4">
        <p>SmartTown uses information and communication technology to improve operational efficiency, share information with the public and provide a better quality of government service and citizen welfare. SmartTown uses internal microservice architecture with functionality exposed through APIs and externally exposed API products while hiding the implementation details.</p>
<p class="image-container"><img src="img/948c3e9782a067f1.jpg"></p>
<h3 is-upgraded>Application Domains</h3>
<p class="image-container"><img src="img/83c8831ad1685cad.jpg"></p>
<p>Though the SmartTown EDA design shall encompass various aspects of automation and control - we will focus on the Analytics and Operations applications for this workshop.</p>
<h3 is-upgraded>Applications</h3>
<p class="image-container"><img src="img/68daf43a1a2bef9.jpg"></p>
<p>A view that captures the relationship between Applications within the Domain based on their publish/subscribe action on the domain events.</p>
<h3 is-upgraded>Events</h3>
<ul>
<li><strong>TemperatureReading</strong> - An event generated by an Temperature Sensor (IoT Device) with temperature reading and a timestamp</li>
<li><strong>OperationalAlert</strong> - An event generated when the temperature is found to be out of bounds with an alert type and prioritization level.</li>
</ul>
<p class="image-container"><img src="img/d44b3a110f0d2d80.jpg"></p>
<aside class="special"><p>Few pointers on the implementation of the microservices in this workshop</p>
</aside>
<ul>
<li>Temperature Sensor data generator  <ul>
<li>A simulator program (microservice) will be used to generate temperature reading</li>
<li>The simulation algorithm would use the current CPU load as a seed to generate temperature readings to cover wider temperature ranges</li>
<li>CPU load shall be manipulated with the use of utilities like _<em>stress</em> or others to increase the CPU load, in turn increase the temperature readings</li>
</ul>
</li>
<li>Alerts Generator  <ul>
<li>With the intent to generate alerts with priority types as</li>
<li>&lt;= 60 - No alert required</li>
<li>60 &lt; Temperature &lt;= 70 - Low Priority Alert</li>
<li>70 &lt; Temperature &lt;= 80 - Medium Priority Alert</li>
<li>Temperature &gt; 80 - High Priority Alert</li>
</ul>
</li>
<li>The scope of <strong>Analytics</strong> in this workshop is limited to plotting the alert on a map.</li>
</ul>
<h2 is-upgraded>References:</h2>
<ul>
<li><a href="https://docs.solace.com/Solace-Cloud/Event-Portal/event-portal.htm" target="_blank">PubSub+ Event Portal - Overview</a></li>
<li><a href="https://solace.com/resources/pubsub-event-portal/eventportal-get-started-demo-video" target="_blank">PubSub+ Event Portal - Getting started</a></li>
<li><a href="https://solace.com/resources/pubsub-event-portal" target="_blank">PubSub+ Event Portal - Resources</a></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Create Application Domain" duration="0">
        <p>We will create an event-driven design for SmartTown functions in the Event Portal using Designer tool. Let us start with defining Application Domain.</p>
<h2 is-upgraded>Define Application Domains</h2>
<p>We will be creating two application domains:</p>
<ol type="1">
<li>SmartTown - Analytics and</li>
<li>SmartTown - Operations</li>
</ol>
<p>âœ… Launch Solace PubSub+ Event Portal and open Designer tool</p>
<ul>
<li>Click on <strong>Create</strong> button next to <strong><em>Application Domain</em></strong></li>
</ul>
<p class="image-container"><img src="img/4ba68074d12a506d.png"></p>
<p>âœ… Create Application Domain - <strong><em>SmartTown - Analytics</em></strong></p>
<ul>
<li>Enter <strong>SmartTown - Analytics</strong> for <strong><em>Name</em></strong></li>
<li>Enter <strong>SmartTown/Analytics</strong> for <strong><em>Topic Domain</em></strong></li>
<li>Click on <strong>Save</strong> button</li>
</ul>
<p class="image-container"><img src="img/bdb8ee6256547f88.png"></p>
<p>âœ… Create Application Domain - <strong><em>SmartTown - Operations</em></strong></p>
<ul>
<li>Enter <strong>SmartTown - Operations</strong> for <strong><em>Name</em></strong></li>
<li>Enter <strong>SmartTown/Operations</strong> for <strong><em>Topic Domain</em></strong></li>
<li>Click on <strong>Save</strong> button</li>
</ul>
<p class="image-container"><img src="img/cf68d1b0e6d8125d.png"></p>
<p>âœ… Now, you should be able to see both the domains in the topology view</p>
<p class="image-container"><img src="img/f28ed507ace08f6c.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Create Schema" duration="0">
        <p>âœ… Create schema under <strong><em>Smart - Operations</em></strong> Application</p>
<p class="image-container"><img src="img/ba42e16df86074fa.png"></p>
<p>âœ… Launch create schema page</p>
<p class="image-container"><img src="img/3a2892f9f31bff04.png"></p>
<h2 is-upgraded>Create Schema - <strong><em>TemperatureReading</em></strong></h2>
<p>The following section describes the event schema to be used for TemperatureReading Event. It captures the geo-location of the sensor (lat, long), city name, city name and cpu-load attributes.</p>
<pre><code>{
    &#34;$schema&#34;: &#34;http://json-schema.org/draft-07/schema&#34;,
    &#34;type&#34;: &#34;object&#34;,
    &#34;title&#34;: &#34;The root schema&#34;,
    &#34;description&#34;: &#34;The root schema comprises the entire JSON document.&#34;,
    &#34;default&#34;: {},
    &#34;examples&#34;: [
      {
        &#34;m_city&#34;: &#34;San Francisco&#34;,
        &#34;m_cpu_temp&#34;: 55.6875,
        &#34;m_cpu_load&#34;: 3.0550130208333335,
        &#34;m_latitude&#34;: 13.04302978515625,
        &#34;m_longitude&#34;: 80.27391815185547
      }
    ],
    &#34;required&#34;: [
      &#34;m_city&#34;,
      &#34;m_cpu_temp&#34;,
      &#34;m_cpu_load&#34;,
      &#34;m_latitude&#34;,
      &#34;m_longitude&#34;
    ],
    &#34;properties&#34;: {
      &#34;m_city&#34;: {
        &#34;type&#34;: &#34;string&#34;,
        &#34;title&#34;: &#34;The m_city schema&#34;,
        &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
        &#34;default&#34;: &#34;&#34;,
        &#34;examples&#34;: [
          &#34;San Francisco&#34;
        ]
      },
      &#34;m_cpu_temp&#34;: {
        &#34;type&#34;: &#34;number&#34;,
        &#34;title&#34;: &#34;The m_cpu_temp schema&#34;,
        &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
        &#34;default&#34;: 0,
        &#34;examples&#34;: [
          55.6875
        ]
      },
      &#34;m_cpu_load&#34;: {
        &#34;type&#34;: &#34;number&#34;,
        &#34;title&#34;: &#34;The m_cpu_load schema&#34;,
        &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
        &#34;default&#34;: 0,
        &#34;examples&#34;: [
          3.0550130208333335
        ]
      },
      &#34;m_latitude&#34;: {
        &#34;type&#34;: &#34;number&#34;,
        &#34;title&#34;: &#34;The m_latitude schema&#34;,
        &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
        &#34;default&#34;: 0,
        &#34;examples&#34;: [
          13.04302978515625
        ]
      },
      &#34;m_longitude&#34;: {
        &#34;type&#34;: &#34;number&#34;,
        &#34;title&#34;: &#34;The m_longitude schema&#34;,
        &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
        &#34;default&#34;: 0,
        &#34;examples&#34;: [
          80.27391815185547
        ]
      }
    },
    &#34;additionalProperties&#34;: true
  }
</code></pre>
<aside class="special"><p>You can copy the above JSON text and paste it in the <strong>Content</strong> section of the schema create dialog.</p>
</aside>
<p>In the Create Schema page:</p>
<ul>
<li>Enter <strong>TemperatureReading</strong> for <strong><em>Name</em></strong></li>
<li>Enable the checkbox for <strong><em>Shared</em></strong></li>
<li>Choose <strong>JSON</strong> for <strong><em>Content Type</em></strong></li>
<li>Copy the above JSON text and paste it in the <strong>Content</strong> textfield</li>
<li>Click on <strong>Save</strong> button</li>
</ul>
<p class="image-container"><img src="img/7be3d138c002abb5.png"></p>
<h2 is-upgraded>Define Schema - <strong><em>OperationalAlert</em></strong></h2>
<p>The following section describes the event schema to be used for OperationalAlert Event. It captures the geo-location of the sensor (lat, long), temperature, city name, attributes.</p>
<pre><code>{
  &#34;$schema&#34;: &#34;http://json-schema.org/draft-07/schema&#34;,
  &#34;type&#34;: &#34;object&#34;,
  &#34;title&#34;: &#34;The root schema&#34;,
  &#34;description&#34;: &#34;The root schema comprises the entire JSON document.&#34;,
  &#34;default&#34;: {},
  &#34;examples&#34;: [
    {
      &#34;lat&#34;: -71.518929,
      &#34;long&#34;: -71.518929,
      &#34;city&#34;: &#34;Hopkinton&#34;,
      &#34;alertType&#34;: &#34;HighTemperature&#34;,
      &#34;severity&#34;: &#34;Medium&#34;,
      &#34;temperature&#34;: 99.3
    }
  ],
  &#34;required&#34;: [
    &#34;lat&#34;,
    &#34;long&#34;,
    &#34;city&#34;,
    &#34;alertType&#34;,
    &#34;severity&#34;,
    &#34;temperature&#34;
  ],
  &#34;properties&#34;: {
    &#34;lat&#34;: {
      &#34;type&#34;: &#34;number&#34;,
      &#34;title&#34;: &#34;The lat schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: 0,
      &#34;examples&#34;: [
        -71.518929
      ]
    },
    &#34;long&#34;: {
      &#34;type&#34;: &#34;number&#34;,
      &#34;title&#34;: &#34;The long schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: 0,
      &#34;examples&#34;: [
        -71.518929
      ]
    },
    &#34;city&#34;: {
      &#34;type&#34;: &#34;string&#34;,
      &#34;title&#34;: &#34;The city schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: &#34;&#34;,
      &#34;examples&#34;: [
        &#34;Hopkinton&#34;
      ]
    },
    &#34;alertType&#34;: {
      &#34;type&#34;: &#34;string&#34;,
      &#34;title&#34;: &#34;The alertType schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: &#34;&#34;,
      &#34;examples&#34;: [
        &#34;HighTemperature&#34;
      ]
    },
    &#34;severity&#34;: {
      &#34;type&#34;: &#34;string&#34;,
      &#34;title&#34;: &#34;The severity schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: &#34;&#34;,
      &#34;examples&#34;: [
        &#34;Medium&#34;
      ]
    },
    &#34;temperature&#34;: {
      &#34;type&#34;: &#34;number&#34;,
      &#34;title&#34;: &#34;The temperature schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: 0,
      &#34;examples&#34;: [
        99.3
      ]
    }
  },
  &#34;additionalProperties&#34;: true
}
</code></pre>
<aside class="special"><p>You can copy the above JSON text and paste it in the <strong>Content</strong> section of the schema create dialog.</p>
</aside>
<p>In the Create Schema page:</p>
<ul>
<li>Enter <strong>OperationalAlert</strong> for <strong><em>Name</em></strong></li>
<li>Enable the checkbox for <strong><em>Shared</em></strong></li>
<li>Choose <strong>JSON</strong> for <strong><em>Content Type</em></strong></li>
<li>Copy the above JSON text and paste it in the <strong>Content</strong> textfield</li>
<li>Click on <strong>Save</strong> button</li>
</ul>
<p class="image-container"><img src="img/afc6c952d847b26c.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Create Event" duration="0">
        <p>âœ… Create event under <strong><em>Smart - Operations</em></strong> Application Domain</p>
<p class="image-container"><img src="img/20dad93ed16131b5.png"></p>
<p>âœ… Launch create event page</p>
<p class="image-container"><img src="img/694c083f0c9418ba.png"></p>
<h2 is-upgraded>Create Event - TemperatureReading</h2>
<p>The following section describes how to create an event and set its attributes - name, logical event mesh, topic address and schema.</p>
<p class="image-container"><img src="img/9bd1fdd78a2056e3.png"></p>
<p>In the Create Event page:</p>
<ul>
<li>Enter <strong>TemperatureReading</strong> for <strong><em>Name</em></strong></li>
<li>Enable the checkbox for <strong><em>Shared</em></strong></li>
<li>Choose <strong>Default Event Mesh</strong> for <strong><em>Logical Event Mesh</em></strong></li>
<li>Choose <strong><em>Schema</em></strong> as selected option for <strong>Value  </strong><ul>
<li>In the first dropdown select <strong>TemperatureReading</strong></li>
<li>In the second dropdown select <strong>All Versions</strong></li>
</ul>
</li>
</ul>
<p>âœ… Launch <strong><em>Set Topic Name</em></strong> page</p>
<p class="image-container"><img src="img/2cdcb299b6fa3f26.png"></p>
<p>âœ… Set Topic page</p>
<p class="image-container"><img src="img/d91901011bbc2c67.png"></p>
<p>âœ… Create level <strong>SmartTown</strong> of <em>Literal</em> type</p>
<p class="image-container"><img src="img/cfc9834278538d9b.png"></p>
<p>âœ… Create level <strong>Operations</strong> at the path <strong><em>SmartTown</em></strong> of <em>Literal</em> type</p>
<p class="image-container"><img src="img/8ddce1ca32e20357.png"></p>
<p>âœ… Create level <strong>temperatureReading</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Operations</em></strong> of <em>Literal</em> type</p>
<p>âœ… Create level <strong>created</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Operations</em></strong>/<strong><em>temperatureReading</em></strong> of <em>Literal</em> type</p>
<p>âœ… Create level <strong>v1</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Operations</em></strong>/<strong><em>temperatureReading</em></strong>/<strong><em>created</em></strong> of <em>Literal</em> type</p>
<p>âœ… Create level <strong>city</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Operations</em></strong>/<strong><em>temperatureReading</em></strong>/<strong><em>created</em></strong>/<strong><em>v1</em></strong> of <em>Variable</em> type</p>
<p class="image-container"><img src="img/887dc0f3d0aa1a20.png"></p>
<p>âœ… Create level <strong>latitude</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Operations</em></strong>/<strong><em>temperatureReading</em></strong>/<strong><em>created</em></strong>/<strong><em>v1</em></strong>/<strong><em>city</em></strong> of <em>Variable</em> type</p>
<p>âœ… Create level <strong>longitude</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Operations</em></strong>/<strong><em>temperatureReading</em></strong>/<strong><em>created</em></strong>/<strong><em>v1</em></strong>/<strong><em>city</em></strong>/<strong><em>latitude</em></strong> of <em>Variable</em> type</p>
<ul>
<li>The final topic name structure</li>
</ul>
<p class="image-container"><img src="img/f7c47dc323afab5e.png"></p>
<ul>
<li>Click on <strong>Set and Return to Event</strong> button</li>
</ul>
<p class="image-container"><img src="img/c8908b5f2f069b4a.png"></p>
<ul>
<li>Click on <strong>Save</strong> button</li>
</ul>
<h2 is-upgraded>Create Event - OperationalAlert</h2>
<p>The following section describes how to create an event and set its attributes - name, logical event mesh, topic address and schema.</p>
<p>In the Create Event page:</p>
<ul>
<li>Enter <strong>OperationalAlert</strong> for <strong><em>Name</em></strong></li>
<li>Enable the checkbox for <strong><em>Shared</em></strong></li>
<li>Choose <strong>Default Event Mesh</strong> for <strong><em>Logical Event Mesh</em></strong></li>
<li>Choose <strong><em>Schema</em></strong> as selected option for <strong>Value  </strong><ul>
<li>In the first dropdown select <strong>OperationalAlert</strong></li>
<li>In the second dropdown select <strong>All Versions</strong></li>
</ul>
</li>
</ul>
<p>âœ… Launch <strong><em>Set Topic Name</em></strong> page</p>
<p>âœ… Create level <strong>SmartTown</strong> of <em>Literal</em> type</p>
<p>âœ… Create level <strong>Operations</strong> at the path <strong><em>SmartTown</em></strong> of <em>Literal</em> type</p>
<p>âœ… Create level <strong>OperationalAlert</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Operations</em></strong> of <em>Literal</em> type</p>
<p>âœ… Create level <strong>created</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Operations</em></strong>/<strong><em>OperationalAlert</em></strong> of <em>Literal</em> type</p>
<p>âœ… Create level <strong>v1</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Operations</em></strong>/<strong><em>OperationalAlert</em></strong>/<strong><em>created</em></strong> of <em>Literal</em> type</p>
<p>âœ… Create level <strong>AlertPriority</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Operations</em></strong>/<strong><em>OperationalAlert</em></strong>/<strong><em>created</em></strong>/<strong><em>v1</em></strong> of <em>Variable</em> type</p>
<p>âœ… Create level <strong>AlertType</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Operations</em></strong>/<strong><em>OperationalAlert</em></strong>/<strong><em>created</em></strong>/<strong><em>v1</em></strong>/<strong><em>AlertPriority</em></strong> of <em>Variable</em> type</p>
<ul>
<li>The final topic name structure</li>
</ul>
<p class="image-container"><img src="img/4b5c7bfea7538adf.png"></p>
<ul>
<li>Click on <strong>Set and Return to Event</strong> button</li>
</ul>
<p class="image-container"><img src="img/c924decb4253f4d1.png"></p>
<ul>
<li>Click on <strong>Save</strong> button  <h2 is-upgraded>Events List</h2>
</li>
</ul>
<p class="image-container"><img src="img/24a74178f37de159.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Create Application" duration="0">
        <p>âœ… Create application under <strong><em>SmartTown - Operations</em></strong><img src="img/a3ab3dad45b30334.png"></p>
<p>âœ… Launch create application option</p>
<p class="image-container"><img src="img/cef4230f892dc4c0.png"></p>
<h2 is-upgraded>Create Application - Temperature Sensors	</h2>
<p>The following section describes how to create an application and set its attributes - name, application type and event association.</p>
<p>In the Create Application page:</p>
<ul>
<li>Enter <strong>Temperature Sensors</strong> for <strong><em>Name</em></strong></li>
<li>Choose <strong><em>Standard</em></strong> as selected option for <strong>Application Type</strong></li>
</ul>
<p class="image-container"><img src="img/8bda94a752be63a5.png"></p>
<p>âœ… Launch <strong><em>Manage</em></strong> events page</p>
<p class="image-container"><img src="img/b8002bc73e8588fc.png"></p>
<p>âœ… Set Publish/Subscribe permissions on Events</p>
<p>In the Manage Events page:</p>
<ul>
<li>Identify the Events relevant to the application</li>
<li>Click on <strong>Sub</strong> or <strong>Pub</strong> icon on the Event row indicating the event relationship with the application (permitted to publish and/or subscribe)</li>
</ul>
<p class="image-container"><img src="img/e46379900b40f09f.png"></p>
<h2 is-upgraded>Create Application - Heating Cooling Controllers - EXTERNAL	</h2>
<p>The following section describes how to create an application and set its attributes - name, application type and event association.</p>
<p>In the Create Application page:</p>
<ul>
<li>Enter <strong>Heating Cooling Controllers - EXTERNAL</strong> for <strong><em>Name</em></strong></li>
<li>Choose <strong><em>Standard</em></strong> as selected option for <strong>Application Type</strong></li>
</ul>
<p>âœ… Launch <strong><em>Manage</em></strong> events page and set Publish/Subscribe permissions on Events</p>
<p>In the Manage Events page:</p>
<ul>
<li>Identify the Events relevant to the application</li>
<li>Click on <strong>Sub</strong> or <strong>Pub</strong> icon on the Event row indicating the event relationship with the application (permitted to publish and/or subscribe)</li>
<li>Click on <strong>Save</strong> button</li>
</ul>
<p class="image-container"><img src="img/78c9080c5b0505a6.png"></p>
<h2 is-upgraded>Applications List</h2>
<p class="image-container"><img src="img/7fa6599765eefbd3.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Event API Product" duration="0">
        <p>An Event API Product can be composed of events from either Solace PubSub+ Event Broker or Kafka for external developers&#39; consumption, enabling them to build event-driven applications that can subscribe to and/or publish the specified events.</p>
<p>The events bundled in an Event API Product can be added from one or more application domains, so you can mix and match events. Event API is all about identifying and bundling high-value events for external consumption similar to REST APIs.</p>
<p>The following diagram demonstrates the co-existence of REST &amp; Events based APIs serving both internal and external applications.</p>
<p class="image-container"><img src="img/d011d91ad19822f2.png"></p>
<p>When it comes to value and exposure, Event-driven applications can combine the classic system and business events to create a bundle as a specification without exposing any of the internal or implementation details. Solace PubSub+ uses AsyncAPI as the standard for API specification for exposing such Event API bundles. Consuming applications also benefits from AsyncAPI&#39;s code-generation facility to focus just on the business logic and not the mundane tasks.</p>
<p class="image-container"><img src="img/1fb8787c46d1cee0.png"></p>
<h2 is-upgraded>References:</h2>
<ul>
<li>Getting started with PubSub+ Cloud <a href="https://docs.solace.com/Solace-Cloud/ggs_signup.htm" target="_blank">Documentation</a></li>
<li>Event API Products <a href="https://docs.solace.com/Solace-Cloud/Event-Portal/event-api-products.htm" target="_blank">Documentation</a></li>
<li>Understanding the Concept of an Event Portal - An API Portal for Events <a href="hthttps://solace.com/blog/api-portal-for-events/" target="_blank">Blog</a></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Create Event API Product" duration="0">
        <p>Next step in building an Event API product involves bundling of high-value, share-worthy events. The resulting bundle is released as a specification for public consumption. The generated specification is based on a commonly understood standard - like AsyncAPI.</p>
<p>AsyncAPI also provides tools to generate code (supports popular languages) helping consumers directly go from spec-to-code, leaving the only responsibility of updating the business logic.</p>
<p>âœ… Launch API Products</p>
<p class="image-container"><img src="img/538a74730483810.png"></p>
<h2 is-upgraded>Create EventAPI Product</h2>
<p>âœ… Configure the API Product settings</p>
<p>In the Create Event API Product page:</p>
<ul>
<li>Enter <strong>HVAC  Controller</strong> for <strong><em>Name</em></strong></li>
<li>Choose <strong>Default Event Mesh</strong> for <strong><em>Logical Event Mesh</em></strong></li>
<li>Enter <strong>localhost:55555</strong> for <strong><em>Server URL</em></strong></li>
<li>Enter <strong>smf</strong> for <strong><em>Server Protocol</em></strong></li>
</ul>
<aside class="warning"><p>Do not yet click on <strong>Save</strong> button, we will configure the Events and then save.</p>
</aside>
<p class="image-container"><img src="img/182f8e2ca3073fab.png"></p>
<p>âœ… Configure Event settings</p>
<p class="image-container"><img src="img/2ab249813f8cfbee.png"></p>
<ul>
<li>Click on the <strong>Add Events</strong> button</li>
</ul>
<p class="image-container"><img src="img/82bd15e19d3085d1.png"></p>
<ul>
<li>Select <strong>TemperatureReading</strong> and <strong>OperationalAlert</strong> events</li>
<li>Click on the <strong>Apply</strong> button</li>
</ul>
<p class="image-container"><img src="img/fa955d93caaf3a0d.png"></p>
<ul>
<li>Mark <strong>TemperatureReading</strong> with <strong><em>Subscribe</em></strong> permission</li>
<li>Mark <strong>OperationalAlert</strong> with <strong><em>Publish</em></strong> permission</li>
<li>Click on the <strong>Save</strong> button</li>
</ul>
<p>âœ… Event API Product list</p>
<p class="image-container"><img src="img/5eec84673b3881e3.png"></p>
<p>âœ… <strong>HVAC Controller</strong> Details</p>
<p class="image-container"><img src="img/5f21e434824b460b.png"></p>
<p>A newly created Event API Product can be made externally available or shared through the following methods:</p>
<ul>
<li>REST API External developers can call a public REST API to retrieve this Event API Product&#39;s AsyncAPI document.</li>
<li>Website External developers can use a website to learn about your available events. Anyone with this URL can access these events.</li>
</ul>
<aside class="warning"><p>This Event API Product&#39;s REST API URL and Website are unavailable for external use until the Event API Product is released</p>
</aside>
<p>These URLs are available only when the API Product is marked as <strong>Released</strong>. To release the API Product, click on the <strong>Release</strong> button at the top right.</p>
<p>More info about the API release and website hosting:</p>
<p class="image-container"><img src="img/c9637ec8df939661.png"></p>
<aside class="special"><p>Do check the <strong>Host Website</strong> option to ensure that the hosted URL is publicly available.</p>
</aside>
<p>With this, the Event API Product named <strong>HVAC Controller</strong> is ready and published for access on public URLs.</p>
<p class="image-container"><img src="img/6c8480d8bd7fc67b.png"></p>
<h3 is-upgraded>Exposed AsyncAPI URL</h3>
<p class="image-container"><img src="img/30c3f2e560d9dddc.jpg"></p>
<p>Interested parties can download the AsyncAPI specification from this public URL and build applications with minimal code using AsyncAPI codegen tools.</p>


      </google-codelab-step>
    
      <google-codelab-step label="AsyncAPI" duration="3">
        <p class="image-container"><img src="img/5f976eae3b11e73e.png"></p>
<p>AsyncAPI has emerged as the industry standard for defining asynchronous, event-driven APIs; you can think of it as OpenAPI for the asynchronous world.</p>
<p>It is an open source initiative that provides both</p>
<ul>
<li>a specification to describe and document your asynchronous applications in a machine-readable format, and</li>
<li>tooling (such as code generators) to make life easier for developers tasked with implementing them.<br></li>
</ul>
<h2 is-upgraded>AsyncAPI Document</h2>
<p>An AsyncAPI document that defines the application that you want to develop. This document can be represented as JSON objects conforming to the JSON standards, or an YAML file. You can either manually create the document or use an event portal.</p>
<p>The AsyncAPI initiative provides a handy, interactive tool called the <a href="https://playground.asyncapi.io" target="_blank">AsyncAPI playground</a> to make the document creation easier.</p>
<p class="image-container"><img alt="AsyncAPI Playground" src="img/71a9c5c8c7eabdb4.jpg"></p>
<p>Alternatively you can generate this document from EDA tools such as <a href="https://solace.com/products/portal/" target="_blank">Event Portal</a> of Solace PubSub+ platform. Typically they are design-time tools allowing architects and developers to collaborate using a GUI to design the event-driven architecture.</p>
<p>Having a catalog of well-organized channels and events for reuse will also save you both time and headaches while collaborating, instead of having to comb through a bunch of files in various locations.</p>
<h2 is-upgraded>AsyncAPI Generator</h2>
<p>AsyncAPI Generator is a tool that can generate a skeleton code from the AsyncAPI document, reducing the need to laboriously create boilerplate code saving time and effort.</p>
<p>The AsyncAPI Code Generator supports templates to generate code for a variety of different languages and protocols, but for this workshop we&#39;re going to use the <a href="https://github.com/asyncapi/java-spring-cloud-stream-template" target="_blank">Spring Cloud Stream template</a>.</p>
<p>The Spring Cloud Stream framework provides an easy way to get started with event-driven microservices by providing binders that allow the developer to create their microservices without having to learn messaging APIs.</p>
<pre><code>Example:

ag ~/AsyncApiDocument.yaml https://github.com/asyncapi/java-spring-cloud-stream-template.git
</code></pre>
<h2 is-upgraded>Coding Business Logic</h2>
<p>The generated spring project is a regular Spring Boot Java project with generated classes under the javaPackage and an <em>application.yml</em> file for configuration. It contains:</p>
<ul>
<li>Generated classes under javaPackage include POJOs defined from the schemas in the AsyncAPI document and</li>
<li><em>Application.java</em> which contains the actual Spring Cloud Functions to handle messages delivered on the channels as defined in the AsyncAPI document where we&#39;ll add our business logic.</li>
</ul>
<h2 is-upgraded>References:</h2>
<ul>
<li><a href="https://www.asyncapi.com/generator" target="_blank">AsyncAPI Code Generator</a></li>
<li><a href="https://github.com/asyncapi/generator#update-the-cli" target="_blank">AsyncAPI Code Generator - GitHub</a></li>
<li><a href="https://solace.com/blog/asyncapi-vs-openapi/" target="_blank">AsyncAPI vs OpenAPI</a></li>
<li><a href="https://solace.com/blog/asyncapi-codegen-microservices-using-spring-cloud-stream/" target="_blank">AsyncAPI Code Generation: Microservices Using Spring Cloud Stream</a></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Download AsyncAPI Document" duration="0">
        <h2 is-upgraded>Review API Product URL</h2>
<p>You can locate the website URL where the EventAPI Product is hosted from the Event API Product settings.</p>
<p class="image-container"><img src="img/6c8480d8bd7fc67b.png"></p>
<p>âœ… Open the website URL in the browser (click on the link)</p>
<p class="image-container"><img src="img/30c3f2e560d9dddc.jpg"></p>
<p>You can click on the <strong>Download YAML</strong> button and download the document from this portal - just you need to move it to the cloudstream folder.</p>
<p>Run the following command on a terminal window</p>
<pre><code>mv ~/Downloads/asyncapi.yaml ~/github/smarttown/cloudstream/
</code></pre>
<aside class="warning"><p>Make sure that the downloaded yml file is moved to the <strong>~/github/smarttown/cloudstream/</strong> folder.<br></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Spring Cloud Stream" duration="3">
        <p class="image-container"><img alt="Cloud Stream Intro" src="img/f4bfccdf4fb492d0.png"></p>
<p>Spring Cloud Stream is a framework for creating highly scalable, event-driven microservices connected by pluggable messaging services. Messaging services are pluggable via Binders that we&#39;ll cover in a bit. The framework is based on Spring Boot and Spring Integration.</p>
<p>Spring Cloud Stream has three different types of message exchange contracts as pictures below.</p>
<ol type="1">
<li>Suppliers are sources of events</li>
<li>Sinks are consumers of events</li>
<li>Processors are both consumers and subscribers of events</li>
</ol>
<h2 is-upgraded>Message Exchange Contracts Map to Java Functions</h2>
<p>As of Spring Cloud Stream v3 the preferred programming model is to use Java Functions to implement your cloud stream apps.</p>
<p>We just mentioned the 3 types of Cloud Stream message exchange contract are &#34;Sources&#34;, &#34;Sinks&#34; and &#34;Processors&#34;. Those map to functions as follows:</p>
<ul>
<li><code>java.util.function.Supplier</code> -&gt; Source [Producer/Publisher of Events]</li>
<li><code>java.util.function.Consumer</code> -&gt; Sink [Subscriber/Consumer of Events]</li>
<li><code>java.util.function.Function</code> -&gt; Processor [ Consumes, Processes, and Produces Events ]</li>
</ul>
<h2 is-upgraded>Binders</h2>
<p>Spring Cloud Stream Binders are really what make the framework useful. Binders provide an abstraction layer between your code and the messaging systems over which events are flowing. This allows you to write your code without having to worry about learning messaging APIs! When messages are sent or received from the messaging system they pass through the messaging system specific binder which knows how to communicate with that specific message broker.</p>
<p>As of the creation of this codelab the available Cloud Stream Binders are:</p>
<ul>
<li>RabbitMQ</li>
<li>Apache Kafka</li>
<li>Amazon Kinesis</li>
<li>Google PubSub</li>
<li>Solace PubSub+</li>
<li>Azure Event Hubs</li>
<li>Apache RocketMQ</li>
</ul>
<aside class="special"><p>Today we&#39;re going to use the <a href="https://github.com/SolaceProducts/solace-spring-cloud/tree/master/solace-spring-cloud-starters/solace-spring-cloud-stream-starter" target="_blank">Solace PubSub+ Binder</a> which supports publish subscribe and consumer groups.</p>
</aside>
<h2 is-upgraded>Communication Models</h2>
<p>Instead of having to learn Messaging APIs, developers just have to understand the communication models that Spring Cloud Stream supports. There are 3 supported models, but support varies per binder.</p>
<ol type="1">
<li>Publish-subscribe: subscribers are independent from each other &amp; receive events in order</li>
<li>Consumer groups: fan-out and load-balancing across multiple consumers</li>
<li>Stateful partitioning support: in-order processing for consistency and performance</li>
</ol>
<h2 is-upgraded>References:</h2>
<ul>
<li>The Spring Cloud Stream <a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-stream/current/reference/html/spring-cloud-stream.html#spring-cloud-stream-reference" target="_blank">Reference Guide</a></li>
<li>Spring Sample <a href="https://github.com/spring-cloud/spring-cloud-stream-samples" target="_blank">Github Repository</a></li>
<li>Solace Sample <a href="https://github.com/SolaceSamples/solace-samples-spring" target="_blank">Github Repository</a></li>
<li>Solace Codelab - <a href="https://codelabs.solace.dev/codelabs/spring-cloud-stream-basics/" target="_blank">Spring Cloud Stream - Basics</a></li>
<li>Solace Codelab - <a href="https://codelabs.solace.dev/codelabs/spring-cloud-stream-beyond" target="_blank">Spring Cloud Stream - Beyond the Basics</a></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Spring Cloud Stream - API Connection" duration="0">
        <p>Launch the Broker Service from PubSub+ Console and open the connection tab.</p>
<p class="image-container"><img src="img/fa773bb2812ac97b.jpg"></p>
<p>Click on <strong>Get Started</strong> button next to the Spring Cloud Stream library</p>
<p class="image-container"><img src="img/c3e27dce2a17f5bb.jpg"></p>
<p>Make a note of the <strong>Host URI</strong> from the connection detailsx <img src="img/1fd5cbf5e93617fd.jpg"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Create IoT Data Simulator MicroService" duration="8">
        <p>The directory <strong>github/cloudstream/ac-city-iot-simulator</strong> contains a prebuilt spring cloud stream project that can readily publish temperature reading data. You just have to update the application.yml configuration with host details.</p>
<p>Import the projects under <strong>github/cloudstream/</strong> directory.</p>
<h2 is-upgraded>Launch Spring Tool Suite</h2>
<ul>
<li>Open Spring Cloud Suite tool by clicking on the icon in the desktop</li>
<li>Import cloud stream projects from the smarttown folder as â€˜Existing maven projects&#39; <img src="img/18f6e02d781fe65.jpg"></li>
</ul>
<h2 is-upgraded>Review <strong><em>ac-city-iot-simulator</em></strong> project</h2>
<h3 is-upgraded>TemperatureReading.java</h3>
<p>âœ… Review the TemperatureReading.java file. It carries temperature reading data - a simple POJO with attributes and corresponding getters/setters.</p>
<h3 is-upgraded>Application.java</h3>
<p>âœ… Review the Application.java, specifically the Supplier function.</p>
<pre><code>  @Bean
  Supplier&lt;Message&lt;TemperatureReading&gt;&gt; publishTemperatureData()  {
    // Collect CPU metrics 
    return () -&gt; {
      SystemInfo si = new SystemInfo();
      HardwareAbstractionLayer hal = si.getHardware();
      CentralProcessor processor = hal.getProcessor();
        
      double[] loadAverage = processor.getSystemLoadAverage(1);
          
      BigDecimal cpuLoad = new BigDecimal((loadAverage[0] &lt; 0 ? 0 : loadAverage[0]));
      BigDecimal cpuTemp = new BigDecimal(50.0 + cpuLoad.doubleValue() * 8.0);
        
      // Construct the topic name with alert type and priority as per the Topic hierarchy design
      // SmartTown/Operations/temperatureReading/created/v1/{city}/{latitude}/{longitude}
      String topic = &#34;SmartTown/Operations/temperatureReading/created/v1/&#34; + city + &#34;/&#34; + latitude + &#34;/&#34; + longitude;	        			
      TemperatureReading data = new TemperatureReading(cpuLoad, city, latitude, longitude, cpuTemp);

      logger.info(data.toString());	

      // Set the target destination as the constructed topic name
      return MessageBuilder.withPayload(data)
                .setHeader(BinderHeaders.TARGET_DESTINATION, topic)
                .build();		
    };
  }	

</code></pre>
<p>âœ… The Supplier function is a Cloud Stream message exchange contract that publishes an event to configured Event Broker.</p>
<p>âœ… Notice the topic name construction:</p>
<p><strong>SmartTown/Operations/temperatureReading/created/v1/{city}/{latitude}/{longitude}</strong></p>
<p>The values for variables <em>city, latitude</em> and <em>longitude</em> are read from the configuration file via @Value annotation.</p>
<pre><code>    @Value(&#34;${application.latitude}&#34;)
    public BigDecimal latitude;
    @Value(&#34;${application.longitude}&#34;)
    public BigDecimal longitude;
    @Value(&#34;${application.city}&#34;)
    public String city;

</code></pre>
<p>The topic name is dynamically constructed by concatenating the root topic name and dynamic values picked up from the application configuration.</p>
<p>âœ… The return value from the <em>Supplier</em> function is a Spring Cloud Stream <em>Message</em> that is set with destination as the dynamic topic and published to the Broker.</p>
<p>âœ… The temperature simulation is closely tied to CPU load on the machine, which can be manipulated using <em>stress</em> system utility. The simulation logic is built to generate a temperature value as a multiple of CPU load.</p>
<aside class="special"><p><em>stress</em> utility is used to dynamically increase the CPU load, which in turn affects the simulation to produce higher temperature readings.</p>
</aside>
<h3 is-upgraded>application.yml</h3>
<p>âœ… Review the application.yml</p>
<pre><code>server.port: 8082
application:
  # e.g., New York City
  city: New York City      
  # e.g., 40.713050
  latitude: 40.713050       
  # e.g., -74.007230 
  longitude: -74.007230      
spring:
  cloud:
    function:
      definition: publishTemperatureData
    stream:
      bindings:
        publishTemperatureData-out-0:
          destination: SmartTown/Operations/temperatureReading/created/v1/*/*/*
      binders:
        solace-binder:
          type: solace
          environment:
            solace:
              java:
                # e.g., &#39;tcps://mrri685heajs1.messaging.solace.cloud:55443&#39;
                host: tcps://mrri685heajs1.messaging.solace.cloud:55443  
                msgVpn: solace-eap
                clientUsername: smarttown
                clientPassword: smarttown
logging:
  level:
    root: info
    org:
      springframework: info
</code></pre>
<aside class="special"><p>Update the <strong>host</strong> parameter with the Host URI noted in the previous step to connect with your Broker using Spring Cloud Stream client library.</p>
</aside>
<p>Affect the following changes on the application configuration file:</p>
<ol type="1">
<li>Goto <a href="https://www.latlong.net" target="_blank">Latlang.net</a> and enter your city name to get latitude and longitude values</li>
<li>In the yml file  <ul>
<li>Update your city name</li>
<li>Update latitude</li>
<li>Update longitude</li>
<li>Update the host name (instructor to provide the host name)</li>
</ul>
</li>
<li>Save the file</li>
</ol>
<h3 is-upgraded>Running IoT Data Simulation</h3>
<p>âœ… Open a terminal, change directory to ac-city-iot-simulator project and run the following maven command.</p>
<pre><code>cd ~/github/smarttown/cloudstream/ac-city-iot-simulator
mvn clean spring-boot:run
</code></pre>
<p>This should run the simulator microservice and publish temperature reading events to the Event Broker.</p>
<pre><code>mvn clean 
mvn spring-boot:run
................................
2021-09-30 18:04:59.401  INFO 5981 --- [   scheduling-1] c.e.s.a.datacollector.Application        :
TemperatureReading [mCpuLoad=6.7255859375, mCity=New York City, mLatitude=40.71305, mLongitude=-74.00723, mCpuTemp=103.8046875]
2021-09-30 18:05:00.409  INFO 5981 --- [   scheduling-1] c.e.s.a.datacollector.Application        :
TemperatureReading [mCpuLoad=6.7255859375, mCity=New York City, mLatitude=40.71305, mLongitude=-74.00723, mCpuTemp=103.8046875]
2021-09-30 18:05:01.416  INFO 5981 --- [   scheduling-1] c.e.s.a.datacollector.Application        :
TemperatureReading [mCpuLoad=6.7255859375, mCity=New York City, mLatitude=40.71305, mLongitude=-74.00723, mCpuTemp=103.8046875]
2021-09-30 18:05:02.423  INFO 5981 --- [   scheduling-1] c.e.s.a.datacollector.Application        :
TemperatureReading [mCpuLoad=6.7255859375, mCity=New York City, mLatitude=40.71305, mLongitude=-74.00723, mCpuTemp=103.8046875]
2021-09-30 18:05:03.428  INFO 5981 --- [   scheduling-1] c.e.s.a.datacollector.Application        :
TemperatureReading [mCpuLoad=6.26708984375, mCity=New York City, mLatitude=40.71305, mLongitude=-74.00723, mCpuTemp=100.13671875]
2021-09-30 18:05:04.432  INFO 5981 --- [   scheduling-1] c.e.s.a.datacollector.Application        :
TemperatureReading [mCpuLoad=6.26708984375, mCity=New York City, mLatitude=40.71305, mLongitude=-74.00723, mCpuTemp=100.13671875]
2021-09-30 18:05:05.435  INFO 5981 --- [   scheduling-1] c.e.s.a.datacollector.Application        :
................................
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Create Alert Generator Microservice" duration="10">
        <p>Before we proceed, we have to make minor changes to the AsyncAPI yml file. The yml file is located under <strong>~/github/smarttown/cloudstream/</strong> directory (the last step in <strong><em>Download AsyncAPI Document</em></strong>).</p>
<p>âœ… Make the following updates to the asyncapi.yaml file</p>
<p>Let&#39;s add a few of the template&#39;s configuration options to the download AsyncAPI document.</p>
<p>Add x-scs-function-name: processTemperatureReading under the subscribe operation and the publish operation under our two channels. By adding this you are telling the generator the name of the function you would like to handle events being exchanged and by adding the same function-name for both the subscribe and the publish operation you are saying you want them handled by the same function!</p>
<pre><code>Append the line below 

      x-scs-function-name: processTemperatureReading

a) After 

channels:
  SmartTown/Operations/OperationalAlert/created/v1/{AlertPriority}/{AlertType}:
    subscribe:

b) And after

  SmartTown/Operations/temperatureReading/created/v1/{city}/{latitude}/{longitude}:
    publish:
</code></pre>
<p>With this change, the channels section of the YAML file will look like this</p>
<pre><code>channels:
  SmartTown/Operations/OperationalAlert/created/v1/{AlertPriority}/{AlertType}:
    subscribe:
      x-scs-function-name: processTemperatureReading
      message:
        $ref: &#34;#/components/messages/OperationalAlert&#34;
    parameters:
      AlertType:
        schema:
          type: &#34;string&#34;
      AlertPriority:
        schema:
          type: &#34;string&#34;
  SmartTown/Operations/temperatureReading/created/v1/{city}/{latitude}/{longitude}:
    publish:
      x-scs-function-name: processTemperatureReading
      message:
        $ref: &#34;#/components/messages/TemperatureReading&#34;
    parameters:
      city:
        schema:
          type: &#34;string&#34;
      latitude:
        schema:
          type: &#34;string&#34;
      longitude:
        schema:
          type: &#34;string&#34;
</code></pre>
<p>In the last section of the yml file, in the info section remove the <code>x-view: &#34;provider&#34;</code>.</p>
<pre><code>info:
  x-generated-time: &#34;2021-09-30 13:15 UTC&#34;
  description: &#34;&#34;
  title: &#34;HVAC Controller&#34;
  x-view: &#34;provider&#34;
  version: &#34;1&#34;
</code></pre>
<p>With this change, info section of the YAML file will look like this</p>
<pre><code>info:
  x-generated-time: &#34;2021-09-30 13:15 UTC&#34;
  description: &#34;&#34;
  title: &#34;HVAC Controller&#34;
  version: &#34;1&#34;
</code></pre>
<p>âœ… Save the asyncapi.yaml file</p>
<p>We will be building this microservice using AsyncAPI Generator tool from the AsyncAPI document hosted by the PubSub+ Event Portal.</p>
<aside class="special"><p>A file with required changes is made available in the folder by name <strong>reference.yml</strong> for your reference.<br></p>
</aside>
<h2 is-upgraded>Generate code using AsyncAPI Code Generator</h2>
<p>âœ… Change directory to cloudstream and run the following command</p>
<pre><code>cd ~/github/smarttown/cloudstream
</code></pre>
<p>Run the following command to invoke AsyncAPI code generator utility.</p>
<aside class="warning"><p>Be sure to update the host URI in the <strong>-p host</strong> parameter with the host URL noted from the Spring Cloud Stream connection settings in the previous section.<br></p>
</aside>
<pre><code>ag -o ac-city-alert-generator -p view=provider -p binder=solace -p dynamicType=header -p artifactId=ac-city-alert-generator  -p groupId=com.eap -p javaPackage=com.eap.scs.asyncapi.alertgenerator -p host=tcps://mrri685heajs7.messaging.solace.cloud:55443 -p username=smarttown -p password=smarttown -p msgVpn=solace-eap asyncapi.yaml @asyncapi/java-spring-cloud-stream-template --force-write
</code></pre>
<p>This command will take some time (minute or so) and complete with the following message.</p>
<pre><code>Done! âœ¨
Check out your shiny new generated files at /home/ubuntu/github/smarttown/cloudstream/ac-city-alert-generator.
</code></pre>
<h2 is-upgraded>Open Spring Tool Suite</h2>
<ul>
<li>Open Spring Cloud Suite tool by clicking on the icon in the desktop (if not open already)</li>
<li>Import cloud stream projects from the smarttown folder as â€˜Existing maven projects&#39; and choose smarttown/cloudstream folder. <img src="img/abdd429eeb4200de.jpg"></li>
</ul>
<h3 is-upgraded>TemperatureReading.java</h3>
<p>âœ… Review the TemperatureReading.java file. It carries temperature reading data - a simple POJO with attributes and corresponding getters/setters.</p>
<p>It is same as the TemperatureReading POJO present in the ac-city-iot-simulator microservice.</p>
<h3 is-upgraded>OperationalAlert.java</h3>
<p>âœ… Review the OperationalAlert.java file. It carries operational alert data - a simple POJO with attributes and corresponding getters/setters.</p>
<h3 is-upgraded>Application.java</h3>
<p>âœ… Review the Application.java, specifically the Supplier function.</p>
<p>Let us review the Function</p>
<pre><code>@Bean
  public Function&lt;TemperatureReading, Message&lt;OperationalAlert&gt;&gt; processTemperatureReading() {
    return data -&gt; {
      // Add business logic here.
      logger.info(data.toString());
      String alertType = &#34;string&#34;;
      String alertPriority = &#34;string&#34;;
      String topic = String.format(&#34;SmartTown/Operations/OperationalAlert/created/v1/%s/%s&#34;,
        alertType, alertPriority);
      OperationalAlert payload = new OperationalAlert();
      Message message = MessageBuilder
        .withPayload(payload)
        .setHeader(BinderHeaders.TARGET_DESTINATION, topic)
        .build();

      return message;
    };
  }
</code></pre>
<p>This Spring Cloud Stream <em>Function</em> contract is a processor that subscribes to <strong>TemperatureReading</strong> message, and publishes a <strong>OperationalAlert</strong> message.</p>
<p>The business logic of what transpires in this function is something we will be coding here. Our goal is to generate Alerts of HighTemperature type with three distinct priority levels:</p>
<ul>
<li>LOW: When temperature &gt; 60 and &lt;= 70</li>
<li>MEDIUM: When temperature &gt; 70 and &lt;= 80</li>
<li>HIGH: When temperature &gt; 80</li>
</ul>
<p>With the updated logic, the Function contract will be</p>
<pre><code>@Bean
public Function&lt;TemperatureReading, Message&lt;OperationalAlert&gt;&gt; processTemperatureReading() {
  return data -&gt; {
    // NOTE: A return value of null indicates that no message will be published to the Broker 
    if (data.getMCpuTemp().doubleValue() &lt;= 60)
      return null;
    
    // Since the goal is to generate temperature alerts, set the alertType to a 
    // default value of &#39;HighTemperature&#39; 
    String alertType = &#34;HighTemperature&#34;; // HighCpuLoad
    
    // Based on the defined bounds for Low, Medium and High temperature,
    // check the incoming temperature reading and set the alert priority appropriately
    String alertPriority = &#34;High&#34;;
    if (data.getMCpuTemp().doubleValue() &gt; 60 &amp;&amp; data.getMCpuTemp().doubleValue() &lt;= 70)
      alertPriority = &#34;Low&#34;;
    else if (data.getMCpuTemp().doubleValue() &gt; 70 &amp;&amp; data.getMCpuTemp().doubleValue() &lt;= 80)
      alertPriority = &#34;Medium&#34;;
    
    // Construct the topic name with alert type and priority as per the Topic hierarchy design
    //		SmartTown/Operations/OperationalAlert/created/v1/{AlertPriority}/{AlertType}
    String topic = String.format(&#34;SmartTown/Operations/OperationalAlert/created/v1/%s/%s&#34;,
      alertType, alertPriority);
    
    // Construct an OperatinalAlert object 
    OperationalAlert payload = new OperationalAlert(alertPriority, alertType, data.getMCity(), data.getMCpuTemp(), 
                            data.getMLatitude(), data.getMLongitude());
    
    logger.info(&#34;Operational Alert: \n&#34; + payload.toString());
    

    // Add OperationalAlert as type parameter to Message declaration (AsyncAPI codegen will fix this soon)
    Message&lt;OperationalAlert&gt; message = MessageBuilder
      .withPayload(payload)
      .setHeader(BinderHeaders.TARGET_DESTINATION, topic)
      .build();

    return message;
  };
}
</code></pre>
<p>There could be other internal services like monitor and external applications like analytics, dashboard could subscribe to this Alert event.</p>
<p>âœ… Notice the topic name construction:</p>
<p><strong>SmartTown/Operations/OperationalAlert/created/v1/{AlertPriority}/{AlertType}</strong></p>
<p>The topic name is dynamically constructed by concatenating the root topic name and computed values for <em>AlertPriority</em>, and <em>AlertType</em> .</p>
<p>âœ… The return value from the <em>Function</em> function is a Spring Cloud Stream <em>Message</em> that is set with destination as the dynamic topic and published to the Broker.</p>
<p>âœ… The temperature simulation is closely tied to CPU load on the machine, which can be manipulated using <em>stress</em> system utility. The simulation logic is built to generate a temperature value as a multiple of CPU load.</p>
<h3 is-upgraded>application.yml</h3>
<aside class="special"><p>1. Before you proceed, make sure that you have received connection details for the Solace PubSub+ Event Broker from the instructor and keep it handy.</p>
</aside>
<aside class="special"><p>2. Note the City name you used in the ac-city-iot-simulator microservice, as you would want to use the same city name to subscribe to TemperatureReading events. Otherwise, this microservice will end up receiving TemperatureReading events from all cities.</p>
</aside>
<p>âœ… Review the application.yml</p>
<pre><code>spring:
  cloud:
    function:
      definition: processTemperatureReading
    stream:
      bindings:
        processTemperatureReading-out-0:
          destination: &#39;SmartTown/Operations/OperationalAlert/created/v1/{AlertPriority}/{AlertType}&#39;
        processTemperatureReading-in-0:
          destination: SmartTown/Operations/temperatureReading/created/v1/*/*/*
      binders:
        solace-binder:
          type: solace
          environment:
            solace:
              java:
                host: &#39;tcps://xxxx.messaging.solace.cloud:55443&#39; # connect to your cloud account and get the Host URI from the Spring Boot Java API service
                msgVpn: sprint-eap
                clientUsername: smarttown
                clientPassword: smarttown
logging:
  level:
    root: info
    org:
      springframework: info

</code></pre>
<aside class="special"><p>Update the <strong>host</strong> parameter with the Host URI noted in the previous section to connect with your Broker using Spring Cloud Stream client library.</p>
</aside>
<h3 is-upgraded>Running Alert Generator</h3>
<p>âœ… Open a terminal, change directory to ac-city-alert-generator project and run the following maven command.</p>
<pre><code>cd ~/github/smarttown/cloudstream/ac-city-alert-generator
mvn clean spring-boot:run
</code></pre>
<p>This should run the alert generator microservice that subscribes to temperature reading event and publishes appropriate operational alert  events to the Event Broker.</p>
<pre><code>mvn clean 
mvn spring-boot:run
................................
OperationalAlert [ severity: High alertType: HighTemperature city: New York City temperature: 80.25 lat: 40.71305 _long: -74.00723 ]
2021-10-04 06:03:20.852  INFO 45472 --- [pool-4-thread-1] c.e.s.a.alertgenerator.Application       : Operational Alert:
OperationalAlert [ severity: High alertType: HighTemperature city: New York City temperature: 80.25 lat: 40.71305 _long: -74.00723 ]
2021-10-04 06:03:21.862  INFO 45472 --- [pool-4-thread-1] c.e.s.a.alertgenerator.Application       : Operational Alert:
OperationalAlert [ severity: High alertType: HighTemperature city: New York City temperature: 80.25 lat: 40.71305 _long: -74.00723 ]
2021-10-04 06:03:22.859  INFO 45472 --- [pool-4-thread-1] c.e.s.a.alertgenerator.Application       : Operational Alert:
OperationalAlert [ severity: High alertType: HighTemperature city: New York City temperature: 80.25 lat: 40.71305 _long: -74.00723 ]
2021-10-04 06:03:23.860  INFO 45472 --- [pool-4-thread-1] c.e.s.a.alertgenerator.Application       : Operational Alert:
OperationalAlert [ severity: High alertType: HighTemperature city: New York City temperature: 81.66796875 lat: 40.71305 _long: -74.00723 ]
2021-10-04 06:03:24.867  INFO 45472 --- [pool-4-thread-1] c.e.s.a.alertgenerator.Application       : Operational Alert:
OperationalAlert [ severity: High alertType: HighTemperature city: New York City temperature: 81.66796875 lat: 40.71305 _long: -74.00723 ]
................................
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Simulate Temperature Variation" duration="5">
        <h3 is-upgraded>Running IoT Data Simulation</h3>
<p>âœ… Open a terminal, change directory to ac-city-iot-simulator project and run the following maven command.</p>
<pre><code>cd ~/github/smarttown/cloudstream/ac-city-iot-simulator
mvn clean spring-boot:run
</code></pre>
<p>This should run the simulator microservice and publish temperature reading events to the Event Broker.</p>
<h3 is-upgraded>Running Alert Generator</h3>
<p>âœ… Open a terminal, change directory to ac-city-alert-generator project and run the following maven command.</p>
<pre><code>cd ~/github/smarttown/cloudstream/ac-city-iot-generator
mvn clean spring-boot:run
</code></pre>
<p>This should run the alert generator microservice that subscribes to temperature reading event and publish appropriate operational alert  events to the Event Broker.</p>
<p>This should run the simulator microservice and publish temperature reading events to the Event Broker.</p>
<h3 is-upgraded>Simulating CPU load to generate</h3>
<p>âœ… Open a terminal, change directory to ac-city-alert-generator project and run the following maven command.</p>
<aside class="special"><p><em>stress</em> utility is used to dynamically increase the CPU load, which in turn affects the simulation to produce higher temperature readings.<br></p>
</aside>
<p>To run the stress command, type:</p>
<pre><code>stress -c 6 -t 180  -v    
</code></pre>
<p><strong>Hint:</strong> Simulate load on CPU with 6 worker threads and exit after 180 seconds.</p>
<p>This will simulate load on the VM and till timeout after 180 seconds. As the CPU load varies, it gets translated to temperature variation in the Alert Generator microservice and the readings gets tagged as Low, Medium or High severity appropriately.</p>
<p>Observe that the alerts generated are qualified with Low, High and Medium severity types appropriately as the CPU Load varies.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Alert Aggregator (optional)" duration="8">
        <p>We will extend the workshop to generate an aggregated alert (over a period/duration of 30 seconds) with average temperature and alert nature. In turn these aggregated alerts will be subscribed by a web application using MQTT client in Javascript and plots geo-location markers on Google Maps.</p>
<p>To accomplish that, we would extend the EDA design:</p>
<ul>
<li>Create a Schema <code>AggregateAlert</code></li>
<li>Create a Event <code>AggregateAlert</code></li>
<li>Create Application <code>Heating Cooling Controllers - DASHBOARD</code> and set appropriate permissions</li>
</ul>
<h2 is-upgraded>Create Schema - <strong><em>AggregateAlert</em></strong></h2>
<p>âœ… Create schema <strong>AggregateAlert</strong> under <strong><em>Smart - Analytics</em></strong> Application</p>
<p class="image-container"><img src="img/d0e02558c8da641a.png"></p>
<p>âœ… Launch create schema page</p>
<p class="image-container"><img src="img/586a39aa9dc14aae.png"></p>
<p>The following section describes the event schema to be used for AggregateAlert Event. It captures the geo-location of the sensor (lat, long), city name, city name, aggregate window duration, sample size and average temperature, timestamp along with the severity and alert type attributes.</p>
<pre><code>{
  &#34;$schema&#34;: &#34;http://json-schema.org/draft-07/schema&#34;,
  &#34;type&#34;: &#34;object&#34;,
  &#34;title&#34;: &#34;The root schema&#34;,
  &#34;description&#34;: &#34;The root schema comprises the entire JSON document.&#34;,
  &#34;default&#34;: {},
  &#34;examples&#34;: [
    {
      &#34;lat&#34;: -71.518929,
      &#34;long&#34;: -71.518929,
      &#34;city&#34;: &#34;Hopkinton&#34;,
      &#34;alertType&#34;: &#34;HighTemperature&#34;,
      &#34;severity&#34;: &#34;Medium&#34;,
      &#34;temperature&#34;: 99.3,
      &#34;count&#34;: 30,
      &#34;timeStamp&#34;: &#34;2021-11-29&#39;T&#39;18:37:22.323333&#34;,
      &#34;duration&#34;: 30
    }
  ],
  &#34;required&#34;: [
    &#34;lat&#34;,
    &#34;long&#34;,
    &#34;city&#34;,
    &#34;alertType&#34;,
    &#34;severity&#34;,
    &#34;temperature&#34;,
    &#34;count&#34;,
    &#34;timeStamp&#34;,
    &#34;duration&#34;
  ],
  &#34;properties&#34;: {
    &#34;lat&#34;: {
      &#34;type&#34;: &#34;number&#34;,
      &#34;title&#34;: &#34;The lat schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: 0,
      &#34;examples&#34;: [
        -71.518929
      ]
    },
    &#34;long&#34;: {
      &#34;type&#34;: &#34;number&#34;,
      &#34;title&#34;: &#34;The long schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: 0,
      &#34;examples&#34;: [
        -71.518929
      ]
    },
    &#34;city&#34;: {
      &#34;type&#34;: &#34;string&#34;,
      &#34;title&#34;: &#34;The city schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: &#34;&#34;,
      &#34;examples&#34;: [
        &#34;Hopkinton&#34;
      ]
    },
    &#34;alertType&#34;: {
      &#34;type&#34;: &#34;string&#34;,
      &#34;title&#34;: &#34;The alertType schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: &#34;&#34;,
      &#34;examples&#34;: [
        &#34;HighTemperature&#34;
      ]
    },
    &#34;severity&#34;: {
      &#34;type&#34;: &#34;string&#34;,
      &#34;title&#34;: &#34;The severity schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: &#34;&#34;,
      &#34;examples&#34;: [
        &#34;Medium&#34;
      ]
    },
    &#34;temperature&#34;: {
      &#34;type&#34;: &#34;number&#34;,
      &#34;title&#34;: &#34;The temperature schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: 0,
      &#34;examples&#34;: [
        99.3
      ]
    },
    &#34;count&#34;: {
      &#34;type&#34;: &#34;number&#34;,
      &#34;title&#34;: &#34;The count schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: 0,
      &#34;examples&#34;: [
        30
      ]
    },
    &#34;timeStamp&#34;: {
      &#34;type&#34;: &#34;string&#34;,
      &#34;title&#34;: &#34;The timeStamp schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: 0,
      &#34;examples&#34;: [
        &#34;2021-11-29&#39;T&#39;18:37:22.323333&#34;
      ]
    },
    &#34;duration&#34;: {
      &#34;type&#34;: &#34;number&#34;,
      &#34;title&#34;: &#34;The duration schema&#34;,
      &#34;description&#34;: &#34;An explanation about the purpose of this instance.&#34;,
      &#34;default&#34;: 0,
      &#34;examples&#34;: [
        30
      ]
    }
  },
  &#34;additionalProperties&#34;: true
}
</code></pre>
<aside class="special"><p>You can copy the above JSON text and paste it in the <strong>Content</strong> section of the schema create dialog.</p>
</aside>
<p>In the Create Schema page:</p>
<ul>
<li>Enter <strong>AggregateAlert</strong> for <strong><em>Name</em></strong></li>
<li>Enable the checkbox for <strong><em>Shared</em></strong></li>
<li>Choose <strong>JSON</strong> for <strong><em>Content Type</em></strong></li>
<li>Copy the above JSON text and paste it in the <strong>Content</strong> textfield</li>
<li>Click on <strong>Save</strong> button</li>
</ul>
<p class="image-container"><img src="img/db2e5231a2a776f9.png"></p>
<h2 is-upgraded>Create Event - <strong><em>AggregateAlert</em></strong></h2>
<p>âœ… Create event under <strong><em>Smart - Analytics</em></strong> Application Domain</p>
<p class="image-container"><img src="img/8b46414efae531aa.png"></p>
<p>âœ… Launch create event page</p>
<p class="image-container"><img src="img/855028b5534d144.png"></p>
<p>The following section describes how to create an event and set its attributes - name, logical event mesh, topic address and schema.</p>
<p class="image-container"><img src="img/c1e20975a96e4663.png"></p>
<p>In the Create Event page:</p>
<ul>
<li>Enter <strong>AggregateAlert</strong> for <strong><em>Name</em></strong></li>
<li>Enable the checkbox for <strong><em>Shared</em></strong></li>
<li>Choose <strong>Default Event Mesh</strong> for <strong><em>Logical Event Mesh</em></strong></li>
<li>Choose <strong><em>Schema</em></strong> as selected option for <strong>Value  </strong><ul>
<li>In the first dropdown select <strong>AggregateAlert</strong></li>
<li>In the second dropdown select <strong>All Versions</strong></li>
</ul>
</li>
</ul>
<p>âœ… Launch <strong><em>Set Topic Name</em></strong> page</p>
<p class="image-container"><img src="img/2cdcb299b6fa3f26.png"></p>
<p>âœ… Set Topic page</p>
<p class="image-container"><img src="img/355f66c5a103f1ce.png"></p>
<p>âœ… Create level <strong>AggregateAlert</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Analytics</em></strong> of <em>Literal</em> type</p>
<p class="image-container"><img src="img/b7ba8d783b34f546.png"><img src="img/2e124b962b954bfc.png"></p>
<p>âœ… Create level <strong>created</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Analytics</em></strong>/<strong><em>AggregateAlert</em></strong> of <em>Literal</em> type</p>
<p class="image-container"><img src="img/950f9686c944202d.png"></p>
<p>âœ… Create level <strong>v1</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Analytics</em></strong>/<strong><em>AggregateAlert</em></strong>/<strong><em>created</em></strong> of <em>Literal</em> type</p>
<p>âœ… Create level <strong>city</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Analytics</em></strong>/<strong><em>AggregateAlert</em></strong>/<strong><em>created</em></strong>/<strong><em>v1</em></strong> of <em>Variable</em> type</p>
<p class="image-container"><img src="img/b245c0aff3b0f9e3.png"></p>
<p>âœ… Create level <strong>AlertPriority</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Analytics</em></strong>/<strong><em>AlertPriority</em></strong>/<strong><em>created</em></strong>/<strong><em>v1</em></strong>/<strong><em>city</em></strong> of <em>Variable</em> type</p>
<p>âœ… Create level <strong>AlertType</strong> at the path <strong><em>SmartTown</em></strong>/<strong><em>Analytics</em></strong>/<strong><em>AggregateAlert</em></strong>/<strong><em>created</em></strong>/<strong><em>v1</em></strong>/<strong><em>city</em></strong>/<strong><em>AlertPriority</em></strong> of <em>Variable</em> type</p>
<ul>
<li>The final topic name structure</li>
</ul>
<p class="image-container"><img src="img/9ba5cbfa2ea14c80.png"></p>
<ul>
<li>Click on <strong>Set and Return to Event</strong> button</li>
</ul>
<p class="image-container"><img src="img/586407b93a0ee2ba.png"></p>
<ul>
<li>Click on <strong>Save</strong> button</li>
</ul>
<h2 is-upgraded>Create Application - Heating Cooling Controllers - DASHBOARD	</h2>
<p>The following section describes how to create an application and set its attributes - name, application type and event association.</p>
<p>In the Create Application page:</p>
<ul>
<li>Enter <strong>Heating Cooling Controllers - DASHBOARD</strong> for <strong><em>Name</em></strong></li>
<li>Choose <strong><em>Standard</em></strong> as selected option for <strong>Application Type</strong></li>
</ul>
<p>âœ… Launch <strong><em>Manage</em></strong> events page and set Publish/Subscribe permissions on Events</p>
<p>In the Manage Events page:</p>
<ul>
<li>Identify the Events relevant to the application</li>
<li>Click on <strong>Sub</strong> or <strong>Pub</strong> icon on the Event row indicating the event relationship with the application (permitted to publish and/or subscribe)</li>
<li>Click on <strong>Save</strong> button</li>
</ul>
<p class="image-container"><img src="img/bb820ea22b016376.png"></p>
<h2 is-upgraded>Applications List</h2>
<p class="image-container"><img src="img/ef9d56285cb50482.png"></p>
<h2 is-upgraded>Review <strong><em>ac-city-alert-aggregator</em></strong> project</h2>
<h3 is-upgraded>OperationalAlert.java</h3>
<p>âœ… Review the OperationalAlert.java file. It carries temperature reading data - a simple POJO with alert attributes and corresponding getters/setters.</p>
<h3 is-upgraded>AggregateAlert.java</h3>
<p>âœ… Review the AggregateAlert.java file. It carries average temperature reading and geo details - a simple POJO with attributes and corresponding getters/setters.</p>
<h3 is-upgraded>Application.java</h3>
<p>âœ… Review the Application.java file. The critical aspect of collecting OperationalAlert events (30 seconds time window) and computing city-wise average temperature, severity and publish AggregateAlert events is carried out here.</p>
<h3 is-upgraded>application.yml</h3>
<p>âœ… Review the application.yml</p>
<pre><code>server.port: 8084
spring:
  cloud:
    function:
      definition: aggregateTemperature
    stream:
      bindings:
        aggregateTemperature-out-0:
          destination: &#39;SmartTown/Operations/AggregateAlert/created/v1/*/*/*&#39;
        aggregateTemperature-in-0:
          destination: &#39;SmartTown/Operations/OperationalAlert/created/v1/*/*&#39;
      binders:
        solace-binder:
          type: solace
          environment:
            solace:
              java:
                # e.g., &#39;tcps://mrri685heajs1.messaging.solace.cloud:55443&#39;
                host: tcps://mrri685heajs7.messaging.solace.cloud:55443  
                msgVpn: solace-eap
                clientUsername: smarttown
                clientPassword: smarttown
logging:
  level:
    root: info
    org:
      springframework: info
</code></pre>
<aside class="special"><p>Update the <strong>host</strong> parameter with the Host URI noted in the previous step to connect with your Broker using Spring Cloud Stream client library.</p>
</aside>
<h3 is-upgraded>Running Alert Aggregator</h3>
<p>âœ… Open a terminal, change directory to ac-city-alert-aggregator project and run the following maven command.</p>
<pre><code>cd ~/github/smarttown/cloudstream/ac-city-alert-aggregator
mvn clean spring-boot:run
</code></pre>
<p>This should run the simulator microservice and publish temperature reading events to the Event Broker.</p>
<pre><code>mvn clean 
mvn spring-boot:run
................................
Aggregate for city: San Francisco
AggregateAlert [count=10, severity=Medium, alertType=HighTemperature, city=San Francisco, timeStamp=2021-10-04T12:59:11.730+05:30, temperature=74.2976562500000028421709430404007434844970703125, lat=37.774929, _long=-122.419418]
Aggregate for city: New York City
AggregateAlert [count=10, severity=Medium, alertType=HighTemperature, city=New York City, timeStamp=2021-10-04T12:59:11.750+05:30, temperature=74.487890625000005684341886080801486968994140625, lat=40.71305, _long=-74.00723]
Aggregate for city: Sau Paulo
AggregateAlert [count=9, severity=Medium, alertType=HighTemperature, city=Sau Paulo, timeStamp=2021-10-04T12:59:11.778+05:30, temperature=74.466579861111114269078825600445270538330078125, lat=-23.550520, _long=-46.633308]
Aggregate for city: London
AggregateAlert [count=9, severity=Medium, alertType=HighTemperature, city=London, timeStamp=2021-10-04T12:59:11.803+05:30, temperature=74.466579861111114269078825600445270538330078125, lat=51.507351, _long=-0.127758]
Aggregate for city: Melbourne
AggregateAlert [count=10, severity=Medium, alertType=HighTemperature, city=Melbourne, timeStamp=2021-10-04T12:59:11.830+05:30, temperature=74.2976562500000028421709430404007434844970703125, lat=-37.813629, _long=144.963058]
................................
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Alert Dashboard (optional)" duration="0">
        <h2 is-upgraded>Review <strong><em>ac-city-alert-dashboard</em></strong> project</h2>
<p>Alert Dashboard is a Spring Boot Application that serves static web application with HTML pages &amp; JS scripts. The web application makes a MQTT client connection to the Broker and subscribes to <strong><em>AggregateAlert</em></strong> event, on receipt it simply plots them on the Google Map.</p>
<p>A tooltip facility details the alert nature with information on timestamp, temperature, sample size, city name and geo-coordinates.</p>
<p>âœ… Review the shared.js</p>
<p>The connection details to establish a MQTT client session is retrieved from the following page.</p>
<pre><code>  // eclipse test server
  var deets = {
    host: &#39;mrri685heajs7.messaging.solace.cloud&#39;,
    port: 8443,
    ssl: true,
    username: &#39;smarttown&#39;,
    password: &#39;smarttown&#39;,
  }
  
  var topicName = &#39;SmartTown/Operations/AggregateAlert/created/v1/+/+/+&#39;;
  var windowSizeSecs = 10000;

  // this is for MQTT, it should return a connected or connecting valid Paho client
  function getClientConnection(uniqueID,onMessageArrived,onConnectionLost,onConnect) {
    var client = new Paho.MQTT.Client(deets[&#39;host&#39;], Number(deets[&#39;port&#39;]), uniqueID); // AWS SGP Nano
    // set the callback handlers
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    // define connection options
    var connectOptions = {};
    if (deets[&#39;ssl&#39;] == true) {
      connectOptions[&#34;useSSL&#34;] = true;
    } else {
      connectOptions[&#34;useSSL&#34;] = false;
    }
    //connectOptions[&#34;reconnect&#34;] = true;
    connectOptions[&#34;userName&#34;] = deets[&#39;username&#39;];
    connectOptions[&#34;password&#34;] = deets[&#39;password&#39;];  // AWS SGP Nano
    connectOptions[&#34;onSuccess&#34;] = onConnect;
    // try to connect!
    client.connect(connectOptions);
    return client;
  }

</code></pre>
<aside class="special"><p>Update the <strong>host</strong> parameter with the Host URI noted in the previous step to connect with your Broker using Spring Cloud Stream client library.</p>
</aside>
<p>your Broker using Spring Cloud Stream client library.</p>
<p class="image-container"><img src="img/dc42b83f22042c0d.png"></p>
<h3 is-upgraded>Running Alert Dashboard</h3>
<p>âœ… Open a terminal, change directory to ac-city-alert-dashboard project and run the following maven command.</p>
<pre><code>cd ~/github/smarttown/cloudstream/ac-city-alert-dashboard
mvn clean spring-boot:run
</code></pre>
<p>This should run the simulator microservice and publish temperature reading events to the Event Broker.</p>
<pre><code>mvn clean 
mvn spring-boot:run
................................
2021-10-04 12:49:35.174  INFO 62510 --- [  restartedMain] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
2021-10-04 12:49:35.176  INFO 62510 --- [  restartedMain] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2021-10-04 12:49:35.177  INFO 62510 --- [  restartedMain] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.48]
2021-10-04 12:49:35.194  INFO 62510 --- [  restartedMain] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2021-10-04 12:49:35.194  INFO 62510 --- [  restartedMain] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 363 ms
2021-10-04 12:49:35.248  INFO 62510 --- [  restartedMain] o.s.b.a.w.s.WelcomePageHandlerMapping    : Adding welcome page: class path resource [static/index.html]
2021-10-04 12:49:35.270  WARN 62510 --- [  restartedMain] ion$DefaultTemplateResolverConfiguration : Cannot find template location: classpath:/templates/ (please add some templates or check your Thymeleaf configuration)
2021-10-04 12:49:35.278  INFO 62510 --- [  restartedMain] o.s.b.d.a.OptionalLiveReloadServer       : LiveReload server is running on port 35729
2021-10-04 12:49:35.284  INFO 62510 --- [  restartedMain] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#39;&#39;
2021-10-04 12:49:35.287  INFO 62510 --- [  restartedMain] c.e.scs.asyncapi.dashboard.Application   : Started Application in 0.503 seconds (JVM running for 1303.432)
2021-10-04 12:49:35.289  INFO 62510 --- [  restartedMain] .ConditionEvaluationDeltaLoggingListener : Condition evaluation unchanged
2021-10-04 12:50:09.348  INFO 62510 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet &#39;dispatcherServlet&#39;
2021-10-04 12:50:09.349  INFO 62510 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet &#39;dispatcherServlet&#39;
2021-10-04 12:50:09.349  INFO 62510 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 0 ms
................................
</code></pre>
<h3 is-upgraded>Access Alert Dashboard</h3>
<p>âœ… Open a browser and navigate to <a href="http://localhost:8080/" target="_blank">localhost:8080</a></p>
<p class="image-container"><img src="img/dcf3e712079bec9f.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Takeaways" duration="1">
        <ul>
<li>âœ… The <a href="solace.com/products/portal" target="_blank">Solace PubSub+ Event Portal</a> is an excellent tool to design and visualize your Event-Driven Architecture, discover what events exist, collaborate with your team and kickstart development via exporting of AsyncAPI documents.</li>
<li>âœ… <a href="https://github.com/asyncapi/generator" target="_blank">AsyncAPI Generator</a> templates allow developers to consistently create event-driven applications by generating code skeletons that are pre-wired with the events and channels defined in the AsyncAPI documents.</li>
<li>âœ… <a href="https://spring.io/projects/spring-cloud-stream" target="_blank">Spring Cloud Stream</a> allows developers to implement highly scalable, event-driven microservices without having to learn how to use messaging APIs.</li>
</ul>
<p class="image-container"><img alt="solly_wave" src="img/b8369552009d4b3d.png"></p>
<p class="image-container"><img alt="solly_wave" src="img/9bd2cbed014d29b6.webp"></p>
<p><strong>Thanks for participating in this codelab!</strong> Let us know what you thought in the <a href="https://solace.community" target="_blank">Solace Community Forum</a> and if you found any issues along the way we&#39;d appreciate it if you&#39;d raise them by clicking the <em>Report a mistake</em> button at the bottom left of this codelab.</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
