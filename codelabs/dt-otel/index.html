
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Getting Started with Solace Distributed Tracing and Context Propagation</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/claat-public/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14" ga4id=""></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  codelab-ga4id=""
                  id="dt-otel"
                  title="Getting Started with Solace Distributed Tracing and Context Propagation"
                  environment="web"
                  feedback-link="https://github.com/SolaceDev/solace-dev-codelabs/blob/master/markdown/dt-otel">
    
      <google-codelab-step label="What you&#39;ll learn: Overview" duration="3">
        <p>This codelab will take you through the basics of the Soalce PubSub+ Distributed Tracing feature. The following steps will take you through:</p>
<ul>
<li>Launching and configuring a PubSub+ Event Broker locally via Docker</li>
<li>Launching and configuring the OpenTelemetry Collector Contribution</li>
<li>Launching Jaeger: the open source, end-to-end distributed tracing backend to observe our traces</li>
<li>Publishing and receiving messages to/from the broker to generate broker trace events</li>
<li>Context propagation via auto-instrumented JMS applications that will generate end to end linked traces (publisher – broker – receiver traces)</li>
<li>Context propagation via manual-instrumented JCSMP applications that will generate end to end linked traces (publisher – broker – receiver traces)</li>
</ul>
<p>Upon successful completion of this codelab, we encourage you to experiment with distributed tracing and the environment provided to see how it fits with your use case(s). This can include other message sources, OpenTelemetry exporters, and telemetry analysis tools.</p>
<h2 is-upgraded>Limitations and caveats</h2>
<p>For this release, trace events will be generated for published messages (guaranteed and promoted direct) upon broker receipt and when the message is enqueued by the broker. This release supports context propagation to link traces for the same message from multiple sources. You can find more details about Solace&#39;s support of distributed tracing in the <a href="https://docs.solace.com/Features/Distributed-Tracing/Distributed-Tracing-Overview.htm" target="_blank">documentation</a>.</p>
<p>This codelabs project is provided for demonstration purposes only. The sample applications included herein (<code>solace-publisher</code> and <code>solace-queue-receiver</code>), the configuration, and the setup scripts are not intended for general use, nor do they contain necessary certificates, or configuration for a secure session connection. As such they should only be used in a local environment for feature demonstration purposes only. Please contact your SE for support.</p>
<h2 is-upgraded>Share your findings and projects</h2>
<p>We encourage to share your findings on the <a href="https://solace.community/" target="_blank">Solace Community</a> and start a discussion with the other community members! And if you have any questions feel free to ask there as well</p>
<p class="image-container"><img alt="Solace" src="img/caf2745a1dd11fa8.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="What you need: Prerequisites" duration="5">
        <h2 is-upgraded>Docker</h2>
<p>This codelab relies on the use of Docker. If you do not already have Docker installed, you will first need to do that. <a href="https://www.docker.com/products/docker-desktop/" target="_blank">Docker Desktop</a> can be installed  for ease of use. At least 4 GiB and 2 cores should be made available for Docker. If more physical resources are available, providing more may improve your experience (e.g. 8 GiB and 4 cores).</p>
<aside class="special"><p> For Kubernetes instructions, please refer to the <code>k8s</code> directory in the github repository referenced below</p>
</aside>
<h2 is-upgraded>Java</h2>
<p>This codelab relies on the features found in modern Java JRE version (Open JDK or Oracle JDK when appropriate license is available by user). For this demo you must have Java 16 or higher.</p>
<p>To validate that Java is correctly installed on your system type following commands in your console:</p>
<pre><code language="language-bash" class="language-bash">[solace@dev ~]$ java -version
</code></pre>
<p>If Java is correctly installed on your machine this will be printed indicating a vendor and the version of the Java installed on your machine.</p>
<pre><code language="language-bash" class="language-bash">[solace@dev ~]$ java -version
openjdk version &#34;16&#34; 2021-03-16
OpenJDK Runtime Environment (build 16+36-2231)
OpenJDK 64-Bit Server VM (build 16+36-2231, mixed mode, sharing)
</code></pre>
<h2 is-upgraded>Source code</h2>
<p>The <a href="https://github.com/TamimiGitHub/solace-dt-demo" target="_blank">solace-dt-demo repository</a> contains the following:</p>
<ul>
<li><code>docker-compose.yaml</code> containing the following: <ul>
<li>Docker image of the Solace PubSub+ Event Broker</li>
<li>Docker image of the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib" target="_blank">OpenTelemetry Collector Contrib</a> packaged with a Solace receiver modules</li>
<li>Docker Image for the Jaeger all in one</li>
</ul>
</li>
<li><code>otel-collector-config.yaml</code></li>
<li><code>solace_config_keys.env</code></li>
<li><code>.env</code> (file with environment variables used in a docker compose files)</li>
<li><code>solace-publisher.jar</code> (command line Solace jms application for publishing of messages)</li>
<li><code>solace-queue-receiver.jar</code> (command line Solace jms application for receiving of messages from a JMS Queue)</li>
<li><code>opentelemetry-javaagent.jar</code> OpenTelemetry Java Instrumentation API</li>
<li><code>solace-opentelemetry-jms-integration-{version}.jar</code> <a href="https://repo1.maven.org/maven2/com/solace/solace-opentelemetry-jms-integration/1.1.0/solace-opentelemetry-jms-integration-1.1.0.jar" target="_blank">Solace PubSub+ OpenTelemetry Integration API for JMS</a></li>
<li><code>jms-auto-instrumentation-sampler-sources.jar</code> (Source code for the Solace jms application for publishing and receiving messages)</li>
</ul>
<p>To get access to the above resources, clone the repository as follows</p>
<pre><code language="language-bash" class="language-bash">git clone git@github.com:TamimiGitHub/solace-dt-demo.git
cd solace-dt-demo
</code></pre>
<aside class="warning"><p> Note: If you do not have SSH access configured between your local machine and your github account you will receive the following error while cloning <code>Permission denied (publickey). fatal: Could not read from remote repository</code>. To avoid that, just clone the https link as follows</p>
<pre><code>git clone https://github.com/TamimiGitHub/solace-dt-demo.git
</code></pre>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Launch the required containers" duration="2">
        <p>The following command will download and launch all containers necessary for the codelab (Internet access will be required to download images from Docker hub).</p>
<pre><code language="language-bash" class="language-bash">[solace@dev solace-dt-demo]$ docker compose up -d

...
⠿ otel-collector Pulled                                                                     32.3s

   ⠿ 023b804a592f Pull complete                                                               0.3s
   ⠿ c03681d022c8 Pull complete                                                              31.3s
   ⠿ 2313e8fe3f45 Pull complete                                                              31.4s
 ⠿ solbroker Pulled                                                                          73.2s
   ⠿ 1d6f30850896 Pull complete                                                               9.7s
   ⠿ 39751529f01e Pull complete                                                              65.4s
   ⠿ 4f4fb700ef54 Pull complete                                                              65.5s
   ⠿ 113360f5164b Pull complete                                                              72.2s
[+] Running 4/4
 ⠿ Network solace_msg_net                         Created                                     0.1s
 ⠿ Container solace-dt-demo-jaeger-all-in-one-1  Started                                     1.5s
 ⠿ Container solace-dt-demo-solbroker-1          Started                                     1.6s
 ⠿ Container solace-dt-demo-otel-collector-1     Started   
</code></pre>
<aside class="warning"><p> Be aware  the command demonstrated above is <code>docker compose</code> and not  <code>docker-compose</code>. Make sure to use a recent version. Both <code>docker compose</code> and <code>docker-compose</code> may be available on your system and could differ in version.</p>
</aside>
<h2 is-upgraded>Few notes to the code lab configuration</h2>
<p>The <code>.env</code> file contains several environment variables that are used within the <code>docker-compose.yaml</code> file and may need to be changed by user depends on the runtime environment:</p>
<ul>
<li>Solace PubSub+ broker port <code>55557</code></li>
<li>OpenTelemetry contribution repository collector docker image tag and version for <code>otel/opentelemetry-collector-contrib</code></li>
<li>Solace PubSub+ broker docker image tag and version <code>solace/solace-pubsub-standard</code></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Three Options for Config Management" duration="3">
        <p>You can (generally) configure the Solace PubSub+ broker using three different methods; this section provides a very brief outline of those.</p>
<p>Each section of this codelab that performs a configuration step on the Solace broker will include all three options.</p>
<aside class="warning"><p> Note: do not perform all 3 configuration options, just choose 1 for each section.</p>
</aside>
<p>For any configuration management, you will need a username/password with either admin or read/write level privileges.</p>
<h2 is-upgraded>A. PubSub+ Manager GUI</h2>
<p>The PubSub+ Manager for Solace brokers is a web GUI, usually accessed on port 8080 on the software broker, port 80 of the management plane of the hardware appliance, or via the Solace Cloud console and clicking on &#34;Manage Service&#34; in the top right.</p>
<aside class="special"><p> Tip: throughout the PubSub+ Manager, by clicking on any configuration item or attribute, a &#34;Tip&#34; will show on the right-hand side of the screen describing the object. Built-in help!</p>
</aside>
<p class="image-container"><img alt="alt-text-here" src="img/c1f978145c610f80.png"></p>
<h2 is-upgraded>B. SEMP Management API</h2>
<p>All of the commands and capabilities within the PubSub+ Manager can also be accomplished programmatically via the RESTful <strong>Solace Element Management Protocol</strong> (SEMP) API. For more information on the SEMP API, please consult the following links:</p>
<ul>
<li><a href="https://docs.solace.com/API-Developer-Online-Ref-Documentation/swagger-ui/config/index.html" target="_blank">SEMPv2 Swagger Reference Documentation</a></li>
<li><a href="https://docs.solace.com/SEMP/Using-SEMP.htm" target="_blank">SEMP User Guide</a></li>
</ul>
<aside class="special"><p> All API commands in the codelab assume that the software broker is running locally in docker and that the commands are executed using the default Admin credentials</p>
</aside>
<h2 is-upgraded>C. Command Line Interface (CLI)</h2>
<p>The Solace <strong>Command Line Interface</strong> (CLI) can be reached by one of the following methods (as appropriate):</p>
<ul>
<li>Software broker, SSH to port 2222, and login with the admin username/password</li>
<li>Software broker running as Docker container: <code>sudo docker exec -it <container-name> cli</code></li>
<li>Software broker running as machine image: login to the machine image, then: <code>solacectl cli</code></li>
<li>Hardware appliance: login to port 22 of the management VRF</li>
</ul>
<p>Note that <code>show</code> commands can be run anywhere in CLI, from any &#34;level&#34;.  But configuration commands must be executed in a specific order.</p>
<ul>
<li><a href="https://docs.solace.com/Solace-CLI/Using-Solace-CLI.htm" target="_blank">Solace CLI Reference Documentation</a></li>
<li><a href="https://solace.com/blog/getting-started-solos-cli/" target="_blank">Get Started with CLI (blog)</a></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Message VPN Configuration" duration="3">
        <p>To improve the user&#39;s exposure to the distributed tracing feature, the broker comes with minimal configuration. Here are the step-by-step instructions to configure your broker. Please note that for simplicity&#39;s sake these steps will not go through configuring any TLS settings and as a result, most data will be exchanged in a non-secure manner.</p>
<p>The following minimal configuration is <strong>necessary</strong> on the Message VPN.</p>
<aside class="warning"><p> ⚠️ If these steps aren&#39;t followed, your OpenTelemetry Collector logs will show</p>
</aside>
<pre><code language="language-bash" class="language-bash">&#34;error&#34;: &#34;no supported auth mechanism ([ANONYMOUS])&#34;.
</code></pre>
<p>This message is the Collector warning you that you&#39;re trying to connect to an unsecured resource (i.e. the broker).</p>
<h2 is-upgraded>PubSub+ Manager</h2>
<p>Login to the PubSub+ GUI Manager, then select the default Message VPN:</p>
<p class="image-container"><img alt="alt-text-here" src="img/15a0899a3b6cb4df.png"></p>
<p>Select Access Control -&gt; Client Authentication -&gt; Settings. Double-click the Basic Authentication Type field or click the edit icon on the right:</p>
<p class="image-container"><img alt="alt-text-here" src="img/259109968af5ddc2.png"></p>
<p>Select Internal database from the Type input field and click Apply:</p>
<p class="image-container"><img alt="alt-text-here" src="img/ca7489e3ab6d9222.png"></p>
<h2 is-upgraded>SEMP API</h2>
<pre><code language="language-bash" class="language-bash">curl --location --request PATCH &#39;http://localhost:8080/SEMP/v2/config/msgVpns/default&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: application/json&#39; \
--header &#39;Authorization: Basic YWRtaW46YWRtaW4=&#39; \
--data &#39;{
    &#34;authenticationBasicType&#34;: &#34;internal&#34;
}&#39;
</code></pre>
<h2 is-upgraded>CLI</h2>
<p>First you must access your container; do so by typing the following command.</p>
<pre><code language="language-bash" class="language-bash">[solace@dev solace-dt-demo]$ docker exec -it solace-dt-demo-solbroker-1 /bin/bash

This Solace product is proprietary software of
Solace Corporation. By accessing this Solace product
you are agreeing to the license terms and conditions
located at http://www.solace.com/license-software
</code></pre>
<p>Once inside the container, simply type <code>cli</code>. Note: If you are flying through the steps too quickly, you may need to give the broker a few seconds to fully initialize itself after running the <code>docker compose</code> command from the previous section before being able to access <code>cli</code> successfully.</p>
<pre><code language="language-bash" class="language-bash">[appuser@solbroker sw]$ cli

Solace PubSub+ Standard Version 10.2.xxx

This Solace product is proprietary software of
Solace Corporation. By accessing this Solace product
you are agreeing to the license terms and conditions
located at http://www.solace.com/license-software

Copyright 2004-2022 Solace Corporation. All rights reserved.

To purchase product support, please contact Solace at:
https://solace.com/contact-us/

Operating Mode: Message Routing Node

solbroker&gt;
</code></pre>
<p>The following commands will suffice.</p>
<pre><code language="language-bash" class="language-bash">solbroker&gt; enable
solbroker# configure
solbroker(configure)# message-vpn default
solbroker(configure/message-vpn)# authentication basic auth-type internal
solbroker(configure/message-vpn)# end
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Default Client Username Configuration" duration="2">
        <p>This Client Username will be used later for publishing messages to the broker.</p>
<h2 is-upgraded>PubSub+ Manager</h2>
<p>From the Access Control menu, select the 1) Client Usernames menu, 2.) select the default username from the list and 3.) select Edit from the Action menu:</p>
<p class="image-container"><img alt="alt-text-here" src="img/6e9549eb58905c6a.png"></p>
<p>Change the default username password to <em>default</em> and click Apply:</p>
<p class="image-container"><img alt="alt-text-here" src="img/4b5afdefff585883.png"></p>
<h2 is-upgraded>SEMP API</h2>
<pre><code language="language-bash" class="language-bash">curl --location --request PATCH &#39;http://localhost:8080/SEMP/v2/config/msgVpns/default/clientUsernames/default&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: application/json&#39; \
--header &#39;Authorization: Basic YWRtaW46YWRtaW4=&#39; \
--data &#39;{
  &#34;password&#34;: &#34;default&#34;
}&#39;
</code></pre>
<h2 is-upgraded>CLI</h2>
<pre><code language="language-bash" class="language-bash">solbroker# configure
solbroker(configure)# client-username default message-vpn default
solbroker(configure/client-username)# password default
solbroker(configure/client-username)# end
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Default Client Profile Configuration" duration="2">
        <p>This Client Profile is used by the Client Username configured above.</p>
<h2 is-upgraded>PubSub+ Manager</h2>
<p>Remaining in the default message VPN, navigate to Access Control -&gt; Client Profiles. Apply the following settings to the default Client Profile:</p>
<ol type="1">
<li>Confirm that <em>Send Guaranteed Messages</em> is enabled. Enable if disabled.</li>
<li>Confirm that <em>Receive Guaranteed Messages</em> is enabled. Enable if disabled.</li>
<li>Enable the <em>Reject Messages to Sender On NO Subscription Match Discard</em> setting. <ul>
<li>This setting allows us to illustrate specific error behavior on the broker in a later step.</li>
</ul>
</li>
</ol>
<p class="image-container"><img alt="alt-text-here" src="img/ac80ad7a067fbe2a.png"></p>
<h2 is-upgraded>SEMP API</h2>
<pre><code language="language-bash" class="language-bash">curl --location --request PATCH &#39;http://localhost:8080/SEMP/v2/config/msgVpns/default/clientProfiles/default&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: application/json&#39; \
--header &#39;Authorization: Basic YWRtaW46YWRtaW4=&#39; \
--data &#39;{
  &#34;allowGuaranteedMsgReceiveEnabled&#34;: true,
  &#34;allowGuaranteedMsgSendEnabled&#34;: true,
  &#34;rejectMsgToSenderOnNoSubscriptionMatchEnabled&#34;: true
}&#39;
</code></pre>
<h2 is-upgraded>CLI</h2>
<pre><code language="language-bash" class="language-bash">solbroker# configure
solbroker(configure)# client-profile default message-vpn default
solbroker(configure/client-profile)# message-spool reject-msg-to-sender-on-no-subscription-match
solbroker(configure/client-profile)# end
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Telemetry Profile Configuration" duration="3">
        <p>The Telemetry Profile defines which published messages should be traced as well as who should be allowed to consume those trace messages.</p>
<p>When creating a Telemetry Profile, a Telemetry Queue is created. In this example, the queue name would be <code>#telemetry-trace</code> because we use <code>trace</code> as the profile name when creating the Telemetry Profile. When generated, trace messages will be added to this queue for consumption.</p>
<p>Creating a Telemetry Profile will also cause the broker to create a Client Profile as well as an ACL Profile. Just like the Telemetry Queue, the names of these profiles will take on the format of <code>#telemetry-&#60;telemetry-profile-name&#62;</code>. These profiles must be used by the Client Username or else the Client will not be able to bind to the Telemetry Queue to consume trace messages. In our demo, the <code>Client</code> is the Solace Receiver on OpenTelemetery collector. More on that to come in upcoming steps</p>
<p>Below is a snippet from the OpenTelemetry Collector configuration included in the solace-dt-demo downloaded earlier. Notice how the username, password, and queue name all match the settings configured on the broker. Be sure to update the collector configuration should any of the Telemetry Profile config change on the broker.</p>
<pre><code language="language-yaml" class="language-yaml">receivers:
  otlp:
    protocols:
      grpc:

  solace:
    broker: [solbroker:5672]
    max_unacknowledged: 500
    auth:
      sasl_plain:
        username: trace
        password: trace
    queue: queue://#telemetry-trace
    tls:
      insecure: true
      insecure_skip_verify: true
</code></pre>
<p>First, start by creating the Telemetry Profile.</p>
<h2 is-upgraded>PubSub+ Manager</h2>
<p>Within the default message VPN, navigate to Telemetry and select <em>Create Telemetry Profile</em></p>
<p class="image-container"><img alt="alt-text-here" src="img/1f3f9d9e768b230.png"></p>
<p>Name the profile <em>trace</em> and click Apply. We&#39;ll come back to this page later to update additional settings.</p>
<p class="image-container"><img alt="alt-text-here" src="img/26508580cb4d05a5.png"></p>
<p>Next, we need to enable the receiver. From the trace Telemetry Profile page, select <em>Receiver Connect ACLs</em> and update the <em>Client Connect Default Action</em> to <em>AllowTip: Double-click the input to enable edit mode</em></p>
<p class="image-container"><img alt="alt-text-here" src="img/b55ea50a092f5c2f.png"></p>
<p class="image-container"><img alt="alt-text-here" src="img/e6528d169121e70e.png"></p>
<p>After applying the ACL, edit the trace Telemetry Profile page to enable the <em>Reciever</em> and <em>Trace</em> settings.</p>
<p class="image-container"><img alt="alt-text-here" src="img/e98421faaa3fbaf6.png"></p>
<p>Finally, let&#39;s create a Trace Filter and add a subscription that will attract all topic messages (using the <code>></code> subscription)</p>
<p>Create the filter with name <em>default</em>. Be sure to enable before clicking Apply.</p>
<p class="image-container"><img alt="alt-text-here" src="img/e592cc9bcc6f28a.png"></p>
<p>Add the <code>></code> subscription</p>
<p class="image-container"><img alt="alt-text-here" src="img/e41ee0f137f0066.png"></p>
<p class="image-container"><img alt="alt-text-here" src="img/6ec02abfd7f272f0.png"></p>
<h2 is-upgraded>SEMP API</h2>
<p>First, start by creating the Telemetry Profile and enabling the receiver.</p>
<pre><code language="language-bash" class="language-bash">curl --location &#39;http://localhost:8080/SEMP/v2/config/msgVpns/default/telemetryProfiles&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: application/json&#39; \
--header &#39;Authorization: Basic YWRtaW46YWRtaW4=&#39; \
--data &#39;{
  &#34;msgVpnName&#34;: &#34;default&#34;,
  &#34;receiverAclConnectDefaultAction&#34;: &#34;allow&#34;,
  &#34;receiverEnabled&#34;: true,
  &#34;telemetryProfileName&#34;: &#34;trace&#34;,
  &#34;traceEnabled&#34;: true
}&#39;
</code></pre>
<p>Next, let&#39;s create a filter that will attract all topic messages (using the <code>></code> subscription).</p>
<pre><code language="language-bash" class="language-bash">curl --location &#39;http://localhost:8080/SEMP/v2/config/msgVpns/default/telemetryProfiles/trace/traceFilters&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: application/json&#39; \
--header &#39;Authorization: Basic YWRtaW46YWRtaW4=&#39; \
--data &#39;{
  &#34;enabled&#34;: true,
  &#34;msgVpnName&#34;: &#34;default&#34;,
  &#34;telemetryProfileName&#34;: &#34;trace&#34;,
  &#34;traceFilterName&#34;: &#34;default&#34;
}&#39;
</code></pre>
<p>Add the subscription to the new filter</p>
<pre><code language="language-bash" class="language-bash">curl --location &#39;http://localhost:8080/SEMP/v2/config/msgVpns/default/telemetryProfiles/trace/traceFilters/default/subscriptions&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: application/json&#39; \
--header &#39;Authorization: Basic YWRtaW46YWRtaW4=&#39; \
--data &#39;{
  &#34;msgVpnName&#34;: &#34;default&#34;,
  &#34;subscription&#34;: &#34;&gt;&#34;,
  &#34;subscriptionSyntax&#34;: &#34;smf&#34;,
  &#34;telemetryProfileName&#34;: &#34;trace&#34;,
  &#34;traceFilterName&#34;: &#34;default&#34;
}&#39;
</code></pre>
<h2 is-upgraded>CLI</h2>
<p>First, start by creating the Telemetry Profile.</p>
<pre><code language="language-bash" class="language-bash">solbroker# configure
solbroker(configure)# message-vpn default
solbroker(configure/message-vpn)# create telemetry-profile trace
</code></pre>
<p>Next, open up and enable the receiver.</p>
<pre><code language="language-bash" class="language-bash">solbroker(configure/message-vpn/telemetry-profile)# receiver acl connect default-action allow
solbroker(configure/message-vpn/telemetry-profile)# no receiver shutdown
</code></pre>
<p>Finally, let&#39;s create a filter that will attract all topic messages (using the <code>></code> subscription).</p>
<pre><code language="language-bash" class="language-bash">solbroker(configure/message-vpn/telemetry-profile)# trace
solbroker(...e/message-vpn/telemetry-profile/trace)# no shutdown
solbroker(configure/message-vpn/telemetry-profile)# create filter default
solbroker(...ge-vpn/telemetry-profile/trace/filter)# no shutdown
solbroker(...ge-vpn/telemetry-profile/trace/filter)# create subscription &#34;&gt;&#34;
solbroker(...try-profile/trace/filter/subscription)# end
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="OpenTelemetry Collector Client Username Configuration" duration="3">
        <p>We need to create a new Client Username for binding to the Telemetry Queue because a Client Username can only be used to bind to a Telemetry Queue if it uses both the Telemetry Client Profile and Telemetry ACL Profile. Additionally, the Telemetry Client Profile does not allow the Client to publish persistent messages.</p>
<p>Again we reference a snippet from the OpenTelemetry Collector configuration included in the solace-dt-demo downloaded earlier. Note that the username and password in the configuration must match the credentials configured for the Client Username on the broker in the following steps.</p>
<pre><code language="language-yaml" class="language-yaml">receivers:
  otlp:
    protocols:
      grpc:

  solace:
    broker: [solbroker:5672]
    max_unacknowledged: 500
    auth:
      sasl_plain:
        username: trace
        password: trace
    queue: queue://#telemetry-trace
    tls:
      insecure: true
      insecure_skip_verify: true
</code></pre>
<h2 is-upgraded>PubSub+ Manager</h2>
<p>Within the default message VPN. Navigate to Access Control -&gt; Client Usernames and add a new Client Username.</p>
<p class="image-container"><img alt="alt-text-here" src="img/c87d957df489ec32.png"></p>
<p>Create the new client username with a name of <em>trace</em>. Apply the following settings to the trace client username:</p>
<ol type="1">
<li>Enable the client username</li>
<li>Change the password to <em>trace</em></li>
<li>Assign <em>#telemetry-trace</em> for both the Client Profile and ACL Profile</li>
</ol>
<p class="image-container"><img alt="alt-text-here" src="img/f1c189b0a10c205.png"></p>
<h2 is-upgraded>SEMP API</h2>
<pre><code language="language-bash" class="language-bash">curl --location &#39;http://localhost:8080/SEMP/v2/config/msgVpns/default/clientUsernames&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: application/json&#39; \
--header &#39;Authorization: Basic YWRtaW46YWRtaW4=&#39; \
--data &#39;{
  &#34;aclProfileName&#34;: &#34;#telemetry-trace&#34;,
  &#34;clientProfileName&#34;: &#34;#telemetry-trace&#34;,
  &#34;clientUsername&#34;: &#34;trace&#34;,
  &#34;enabled&#34;: true,
  &#34;msgVpnName&#34;: &#34;default&#34;,
  &#34;password&#34;: &#34;trace&#34;
}&#39;
</code></pre>
<h2 is-upgraded>CLI</h2>
<pre><code language="language-bash" class="language-bash">solbroker# configure
solbroker(configure)# create client-username trace message-vpn default
solbroker(configure/client-username)# password trace
solbroker(configure/client-username)# client-profile #telemetry-trace
solbroker(configure/client-username)# acl-profile #telemetry-trace
solbroker(configure/client-username)# no shutdown
solbroker(configure/client-username)# end
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Messaging Queue Configuration" duration="3">
        <p>Finally, create a queue for attracting messages for our producers and consumers. Add a topic subscription of <code>solace/tracing</code> to the queue.</p>
<h2 is-upgraded>PubSub+ Manager</h2>
<p>Within the default message VPN. Navigate to <em>Queues</em> to create a queue named ‘q&#39; with the specified topic subscription.</p>
<p class="image-container"><img alt="alt-text-here" src="img/6198291fca96ee83.png"></p>
<p>After naming the queue, update the Non-Owner Permission to <em>Delete</em></p>
<p class="image-container"><img alt="alt-text-here" src="img/bbca81b5454a9705.png"></p>
<p>Navigate to the Subscriptions tab for the new queue and select ‘+ Subscription&#39; to add the <code>solace/tracing</code> topic subscription.</p>
<p class="image-container"><img alt="alt-text-here" src="img/a5dc515e7d9308a4.png"></p>
<h2 is-upgraded>SEMP API</h2>
<p>Create the queue</p>
<pre><code language="language-bash" class="language-bash">curl --location &#39;http://localhost:8080/SEMP/v2/config/msgVpns/default/queues&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: application/json&#39; \
--header &#39;Authorization: Basic YWRtaW46YWRtaW4=&#39; \
--data &#39;{
        &#34;msgVpnName&#34;: &#34;default&#34;,
        &#34;egressEnabled&#34;: true,
        &#34;ingressEnabled&#34;:true,
        &#34;permission&#34;: &#34;delete&#34;,
        &#34;queueName&#34;: &#34;q&#34;
        
    }&#39;
</code></pre>
<p>Add the topic subscription</p>
<pre><code language="language-bash" class="language-bash">curl --location &#39;http://localhost:8080/SEMP/v2/config/msgVpns/default/queues/q/subscriptions&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: application/json&#39; \
--header &#39;Authorization: Basic YWRtaW46YWRtaW4=&#39; \
--data &#39;{
  &#34;msgVpnName&#34;: &#34;default&#34;,
  &#34;queueName&#34;: &#34;q&#34;,
  &#34;subscriptionTopic&#34;: &#34;solace/tracing&#34;
}&#39;
</code></pre>
<h2 is-upgraded>CLI</h2>
<pre><code language="language-bash" class="language-bash">solbroker# configure
solbroker(configure)# message-spool message-vpn default
solbroker(configure/message-spool)# create queue q
solbroker(configure/message-spool/queue)# permission all delete
solbroker(configure/message-spool/queue)# subscription topic solace/tracing
solbroker(configure/message-spool/queue)# no shutdown
solbroker(configure/message-spool/queue)# end
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Verifying your broker configuration" duration="2">
        <h2 is-upgraded>Verifying your telemetry queue</h2>
<p>As previously mentioned, a special Telemetry Queue should have been created when the Telemetry Profile was created. The client bound to the Telemetry Queue is the Solace Receiver Module, part of the OpenTelemetry Collector application that was launched in an earlier step.</p>
<h3 is-upgraded>PubSub+ Manager</h3>
<p>From Queues, select the <em>#telemetry-trace</em> queue and confirm the following settings:</p>
<ol type="1">
<li>Current Consumers: 1</li>
<li>Access Type: Non-Exclusive</li>
<li>Durable: Yes</li>
</ol>
<p class="image-container"><img alt="alt-text-here" src="img/655a8366f40255c7.png"></p>
<h3 is-upgraded>SEMP API</h3>
<p>Fetch the #telemetry-trace data form the monitor API and confirm the following settings:</p>
<ol type="1">
<li>Current Consumers: 1</li>
<li>Access Type: Non-Exclusive</li>
<li>Durable: Yes</li>
</ol>
<pre><code language="language-bash" class="language-bash">curl --location &#39;http://localhost:8080/SEMP/v2/monitor/msgVpns/default/queues/%23telemetry-trace&#39; \
--header &#39;Accept: application/json&#39; \
--header &#39;Authorization: Basic YWRtaW46YWRtaW4=&#39; \
</code></pre>
<h3 is-upgraded>CLI</h3>
<p>Now that all configuration has been applied to the broker, you should see a Bind Count of &#34;1&#34; on your Telemetry Queue.</p>
<pre><code language="language-bash" class="language-bash">solbroker# show queue #telemetry-trace

Flags Legend:
I - Ingress Admin State (U=Up, D=Down)
E - Egress  Admin State (U=Up, D=Down)
A - Access-Type         (E=Exclusive, N=Non-Exclusive)
S - Selector            (Y=Yes, N=No)
R - Redundancy          (P=Primary, B=Backup)
D - Durability          (D=Durable, N=Non-Durable)
P - Priority            (Y=Yes, N=No)

Queue Name                   Messages      Spool             Bind Status
Message VPN                   Spooled  Usage(MB)   HWM (MB) Count I E A S R D P
------------------------- ----------- ---------- ---------- ----- -------------
#telemetry-trace
default                             0       0.00       0.00     1 D U N N P D N
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Producing trace messages and accessing trace span in Jaeger" duration="7">
        <h2 is-upgraded>Publishing messages using a simple jms application</h2>
<p>We have provided a simple JMS publishing application in <code>solace-publisher.jar</code>.</p>
<p>As you follow the steps in this codelab don&#39;t forget to replace the IP address in the command with your system&#39;s IP address if docker compose is not running on a same host.</p>
<p>If Docker is running on the same system (which is expected) where you are running solace-publisher, you can use the following command:</p>
<pre><code language="language-bash" class="language-bash">[solace@dev solace-dt-demo]$ cd src
[solace@dev solace-dt-demo]$ java -Dsolace.host=localhost:55557 \
-Dsolace.vpn=default \
-Dsolace.user=default \
-Dsolace.password=default \
-Dsolace.topic=solace/tracing -jar solace-publisher.jar
</code></pre>
<h2 is-upgraded>Jaeger UI</h2>
<p>As part of an earlier step, the Jaeger UI was launched. It can be accessed using your favourite browser.</p>
<p>If Docker is running on the same system your browser is running on, you can access the Jaeger UI using the following URI: <a href="http://0.0.0.0:16686/" target="_blank">http://0.0.0.0:16686/</a> or <a href="http://localhost:16686/" target="_blank">http://localhost:16686/</a>. If Docker is running on another system in your network, simply replace <code>0.0.0.0</code> to the system&#39;s IP, e.g. <code>http://192.168.3.166:16686/</code>.</p>
<h2 is-upgraded>Verify published messages are traced in the Jaeger UI</h2>
<p>After the OpenTelemetry Collector has received a message, you should be able to see the solbroker trace. Once the right service has been selected, select &#34;Find Traces&#34; button. <img alt="Jaeger1" src="img/5ab3ad7b433530f0.png"></p>
<p>You should now see a trace for the message published using solace-publisher from the previous step. <img alt="Jaeger2" src="img/1e9819015b047b8b.png"></p>
<p>To view more details about this trace, click on it. You can then expand various boxes so that more information is displayed. <img alt="Jaeger3" src="img/3c86a7cf52c6fc8d.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Jaeger UI - Searching for traces" duration="5">
        <h2 is-upgraded>Publishing more interesting messages</h2>
<p>Let&#39;s publish three messages with user properties so that we can search for them on Jaeger. The messages will contain the following {key,value} pairs.</p>
<ol type="1">
<li>{myKey,myValue1}</li>
<li>{myKey,myValue2}</li>
<li>{myKey,myValue3}</li>
</ol>
<pre><code language="language-bash" class="language-bash">java -Dsolace.user-properties=&#34;myKey=myValue1&#34; -Dsolace.host=localhost:55557 -Dsolace.vpn=default -Dsolace.user=default -Dsolace.password=default -Dsolace.topic=solace/tracing -jar solace-publisher.jar
java -Dsolace.user-properties=&#34;myKey=myValue2&#34; -Dsolace.host=localhost:55557 -Dsolace.vpn=default -Dsolace.user=default -Dsolace.password=default -Dsolace.topic=solace/tracing -jar solace-publisher.jar
java -Dsolace.user-properties=&#34;myKey=myValue3&#34; -Dsolace.host=localhost:55557 -Dsolace.vpn=default -Dsolace.user=default -Dsolace.password=default -Dsolace.topic=solace/tracing -jar solace-publisher.jar
</code></pre>
<h2 is-upgraded>Verifying traced messages in the Jaeger UI</h2>
<p>If you look at the details for the third message published, notice how it has a tag with the user property provided by the publisher. <img alt="Jaeger4" src="img/95aee1dafeeb507c.png"></p>
<p>That value can be used for searching traces. On the Search page, search for the following tag: <code>messaging.solace.user_properties.myKey=myValue3</code> This request should find the third message published. <img alt="Jaeger5" src="img/5c8a4a806e1e255f.png"></p>
<h2 is-upgraded>Using Jaeger to debug problems</h2>
<p>In an earlier section, we created a queue which had a subscription to topic <code>solace/tracing</code>. Let&#39;s try publishing a message to the topic <code>solace/tracing2</code>, a topic for which no client or endpoint is subscribed.</p>
<pre><code language="language-bash" class="language-bash">java -Dsolace.host=localhost:55557 -Dsolace.vpn=default -Dsolace.user=default -Dsolace.password=default -Dsolace.topic=solace/tracing2 -jar solace-publisher.jar
</code></pre>
<p>Notice the message from the app <code>No Subscription Match - Topic 'solace/tracing2'</code>. The message is considered as errored because it was discarded by the broker.</p>
<p>From the Jaeger UI, search for the following tag <code>error=true</code><img alt="Jaeger6" src="img/4f246ed5480e8014.png"></p>
<p>If you select the message and expand its detailed view, you will see that the message published had <code>No Subscription Match</code>. <img alt="Jaeger7" src="img/d59ae475a3e8e8dd.png"></p>
<p>This information can be used to perform any corrective actions, e.g.:</p>
<ul>
<li>Fix the publisher and have it publish to the intended topic</li>
<li>Update the broker configuration and have your queue also subscribe to topic <code>solace/tracing2</code></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Clean-up from previous sections" duration="2">
        <p>If there are messages on your queue from previous sections, let&#39;s take a moment to delete them.</p>
<h3 is-upgraded>PubSub+ Manager</h3>
<p>Login to the PubSub+ Manager console and select the default message VPN. Navigate to Queues and select the ‘q&#39; queue we created earlier. From here navigate to the Messages Queued tab and select all messages.</p>
<p class="image-container"><img alt="alt-text-here" src="img/c803e2beb29f2263.png"></p>
<p>Next, select Action -&gt; Delete Messages and confirm.</p>
<h3 is-upgraded>SEMP API</h3>
<p>Use the Action API to delete all spooled messages from the ‘q&#39; queue</p>
<pre><code language="language-bash" class="language-bash">curl --location --request PUT &#39;http://localhost:8080/SEMP/v2/action/msgVpns/default/queues/q/deleteMsgs&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: application/json&#39; \
--header &#39;Authorization: Basic YWRtaW46YWRtaW4=&#39; \
--data &#39;{}&#39;
</code></pre>
<h3 is-upgraded>CLI</h3>
<pre><code language="language-bash" class="language-bash">solbroker&gt; enable
solbroker# admin
solbroker(admin)# message-spool message-vpn default
solbroker(admin/message-spool)# delete-messages queue q
This will delete all spooled messages in q
Do you want to continue (y/n)? y
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Introduction to Context Propagation" duration="10">
        <p>While the previous examples have provided the ability to trace events as they arrive at the broker, we&#39;re still lacking the context required to know what is occurring at the publisher and at the subscriber. In order to create a trace containing information from end to end, we need to enable context propagation at the publisher and the subscriber.</p>
<p><a href="https://opentelemetry.io/docs/concepts/glossary/#context-propagation" target="_blank">OpenTelemetry.io</a> describes Context Propagation as:</p>
<aside class="special"><p> Allowing all Data Sources to share an underling context mechanism for storing state and accessing data across the lifespan of a Transaction.</p>
</aside>
<p>In other words, Context Propagation is the processes by which we can link individual operations such as <code>send</code>, <code>receive</code>, or <code>process</code> together into a single trace. With OpenTelemetry, these operations are identified by spans and are tied to a single trace by way of parent-child relationships. For a deeper look at Context Propagation for Distributed Tracing, check out the <a href="https://docs.solace.com/Features/Distributed-Tracing/Distributed-Tracing-Context-Propagation.htm#Context_Propagation_for_Distributed_Tracing" target="_blank">Solace Docs</a>.</p>
<p>Now that we know what Context Propagation is, when we can discuss two main ways for enabling it:</p>
<ul>
<li><strong>Auto Instrumentation</strong> - using a side agent as part of the java execution command</li>
<li><strong>Manual Instrumentation</strong> - tracing implemented directly in source code</li>
</ul>
<h2 is-upgraded>Auto Instrumentation</h2>
<p>With <a href="https://opentelemetry.io/docs/instrumentation/java/automatic/" target="_blank">Automatic instrumentation with Java</a>, a Java agent JAR is attached to an existing Java 8+ application. The agent JAR dynamically injects bytecode to capture telemetry within the app or service. This enables the ability to add telemetry to the existing app or service without any code changes or refactoring.</p>
<p class="image-container"><img alt="Autoinstrumentatino.png" src="img/a535c6ded5d0e418.png"></p>
<h2 is-upgraded>Manual Instrumentation</h2>
<p>With Manual instrumentation, applications or services must use the <a href="https://opentelemetry.io/docs/specs/otel/library-guidelines/" target="_blank">OpenTelemetry API</a> to implement tracing directly from the source code. Note that this process requires code changes and refactoring</p>
<p class="image-container"><img alt="ManualInstrumentation.png" src="img/82c2c76edfae3673.png"></p>
<p>While both options allow for the ability to add custom context information to traces (more on this later). Manual instrumentation provides for finer grained control. To determine the best option for your app or service, you must evaluate the time to implement, context required for traces, and existing opentelemetry api support.</p>
<p>In the next few sections, we&#39;ll take a look at how both auto and manual instrumentation can be implemented to enable context propagation at the edge and across your Solace broker.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Auto-instrumentation" duration="10">
        <h2 is-upgraded>Run the publisher with context propagation enabled</h2>
<p>The following command will</p>
<ol type="1">
<li>Launch the opentelemetry java agent</li>
<li>Configure the agent with the solace opentelemetry JMS integration solace-publisher JMS extension</li>
<li>Run the JMS <code>solace-publisher.jar</code> application and publish a message</li>
</ol>
<p>Additional context information will be <strong>automatically</strong> sent to the collector with no code changes to the JMS publishing application thanks to the opentelemetry javaagent.</p>
<aside class="special"><p> Be sure to:</p>
<ul>
<li>Update this argument&#39;s IP to point to your collector: <code>-Dotel.exporter.otlp.endpoint=http://localhost:4317</code></li>
<li>replace <code>{absolute_path_to_the_jar_file}</code> with an absolute path to the <code>solace-dt-demo/src</code> folder on your machine. There are 2 places in the command where this needs to be done.</li>
</ul>
</aside>
<pre><code language="language-bash" class="language-bash">[solace@dev solace-dt-demo]$ 
java -javaagent:&lt;absolute_path_to_the_jar_file&gt;/opentelemetry-javaagent.jar \
-Dotel.javaagent.extensions=&lt;absolute_path_to_the_jar_file&gt;/solace-opentelemetry-jms-integration-1.1.0.jar \
-Dotel.propagators=solace_jms_tracecontext \
-Dotel.exporter.otlp.endpoint=http://localhost:4317 \
-Dotel.traces.exporter=otlp \
-Dotel.metrics.exporter=none \
-Dotel.instrumentation.jms.enabled=true \
-Dotel.resource.attributes=&#34;service.name=SolaceJMSPublisher&#34; \
-Dsolace.host=localhost:55557 \
-Dsolace.vpn=default \
-Dsolace.user=default \
-Dsolace.password=default \
-Dsolace.topic=solace/tracing \
-jar solace-publisher.jar
</code></pre>
<h2 is-upgraded>Run the subscriber with context propagation enabled</h2>
<p>The following command will</p>
<ol type="1">
<li>Launch the opentelemetry java agent</li>
<li>Configure the agent with the solace opentelemetry JMS integration solace-publisher JMS extension</li>
<li>Run the JMS <code>solace-queue-receiver.jar</code> application and consume the message that was just published on to the queue</li>
</ol>
<aside class="special"><p> Be sure to:</p>
<ul>
<li>Update this argument&#39;s IP to point to your collector: <code>-Dotel.exporter.otlp.endpoint=http://localhost:4317</code></li>
<li>replace <code>{absolute_path_to_the_jar_file}</code> with an absolute path to the <code>solace-dt-demo/src</code> folder on your machine. There are 2 places in the command where this needs to be done.</li>
</ul>
</aside>
<pre><code language="language-bash" class="language-bash">[solace@dev solace-dt-demo]$ 
java -javaagent:&lt;absolute_path_to_the_jar_file&gt;/opentelemetry-javaagent.jar \
-Dotel.javaagent.extensions=&lt;absolute_path_to_the_jar_file&gt;/solace-opentelemetry-jms-integration-1.1.0.jar \
-Dotel.propagators=solace_jms_tracecontext \
-Dotel.traces.exporter=otlp \
-Dotel.metrics.exporter=none \
-Dotel.instrumentation.jms.enabled=true \
-Dotel.resource.attributes=&#34;service.name=SolaceJMSQueueSubscriber&#34; \
-Dsolace.host=localhost:55557 \
-Dsolace.vpn=default \
-Dsolace.user=default \
-Dsolace.password=default \
-Dsolace.queue=q \
-Dsolace.topic=solace/tracing \
-jar solace-queue-receiver.jar
</code></pre>
<aside class="warning"><p> Note: When you are done testing and wish to end the solace-queue-receiver application, simply send ctrl+c from the keyboard.</p>
</aside>
<h2 is-upgraded>Verify trace generated in Jaeger</h2>
<p>A new trace should have been generated, notice how it has 3 spans. <img alt="Jaeger8" src="img/e4ea615a936a7866.png"></p>
<p>Opening up the newly generated trace will allow you to easily follow the sequence of events. <img alt="Jaeger9" src="img/353b4557bfe82144.png"></p>
<ul>
<li>The first <strong>SEND</strong> span was generated by the publisher when the message was published.</li>
<li>The second <strong>RECEIVE</strong> span was generated by the PubSub+ Broker when the message was received.</li>
<li>The third <strong>PROCESS</strong> span was generated by the consumer when the message was consumed.</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Manual-instrumentation - Publisher" duration="10">
        <p>In this section, we&#39;ll take a look at how to use the OpenTelemetry API with the <a href="https://mvnrepository.com/artifact/com.solace/solace-opentelemetry-jcsmp-integration" target="_blank">Solace PubSub+ OpenTelemetry Integration For Solace JCSMP API</a>. We&#39;ll start with a simple Publisher application that publishes messages on the <code>solace/tracing</code> topic and update it to produce spans for various operations to enable context propagation at the edges.</p>
<p>The related file can be found in the following directory from the <a href="https://github.com/TamimiGitHub/solace-dt-demo" target="_blank">solace-dt-demo</a> repo <code>solace-dt-demo/manual-instrumentation/jcsmp-publisher/src/main/java/com/solace/samples/Publisher.java</code></p>
<p>After initializing the tracer in the <code>JcsmpTracingUtil.java</code> class we use <em>SolaceJCSMPTextMapGetter</em> to extract existing context from the message</p>
<pre><code language="language-java" class="language-java">//Extract tracing context from message, if any using the SolaceJCSMPTextMapGetter
//It is always advised to extract context before injecting new one
final SolaceJCSMPTextMapGetter getter = new SolaceJCSMPTextMapGetter();
final Context extractedContext = JcsmpTracingUtil.openTelemetry.getPropagators().getTextMapPropagator()
        .extract(Context.current(), message, getter);
</code></pre>
<p>This context is then set as the parent on our new span. As we build out the span we can see how we are able to set specific span attributes and add in our custom attributes.</p>
<pre><code language="language-java" class="language-java"> //Set the extract context as current context
try (Scope parent = extractedContext.makeCurrent()) {
    //Create a child span and set extracted/current context as parent of this span
    final Span sendSpan = JcsmpTracingUtil.tracer
            .spanBuilder(SERVICE_NAME + &#34; &#34; + SpanAttributes.MessagingOperation.SEND)
            .setSpanKind(SpanKind.CLIENT)
            .setAttribute(SpanAttributes.MessagingAttribute.DESTINATION_KIND.toString(),
                    SpanAttributes.MessageDestinationKind.TOPIC.toString())
            .setAttribute(SpanAttributes.MessagingAttribute.IS_TEMP_DESTINATION.toString(), &#34;true&#34;)
            //Set more attributes as needed
            .setAttribute(&#34;myKey&#34;, &#34;myValue&#34; + ThreadLocalRandom.current().nextInt(1, 3))
            .setParent(extractedContext) // set extractedContext as parent
            .startSpan();
// continues below...
</code></pre>
<p>After creating the new span, we are able to inject it back on the message as now current context. After which we go ahead and send our message, making sure to catch relevant errors and end the current span. Only after ending the current span is the data exported to the configured Opentelemetry collector.</p>
<aside class="special"><p> The OpenTelemetry collector is brought in to the application via the _opentelemetry-exporter-otlp_ library. Default settings are used to export to the collector executing in Docker. </p>
</aside>
<pre><code language="language-java" class="language-java">// ...continued from above
    try (Scope scope = sendSpan.makeCurrent()) {
        final SolaceJCSMPTextMapSetter setter = new SolaceJCSMPTextMapSetter();
        final TextMapPropagator propagator = JcsmpTracingUtil.openTelemetry.getPropagators().getTextMapPropagator();
        //and then inject new current context (set by sendSpan.makeCurrent()) in the message
        propagator.inject(Context.current(), message, setter);
        try {
            producer.send(message, topic);  // send the message
            msgSentCounter++;  // add one
            message.reset();   // reuse this message, to avoid having to recreate it: better performance
        } catch (JCSMPException e) {
            System.out.printf(&#34;### Caught while trying to producer.send(): %s%n&#34;, e);
            if (e instanceof JCSMPTransportException) {  // all reconnect attempts failed
            isShutdown = true;  // let&#39;s quit; or, could initiate a new connection attempt
        }
            throw e;
        }
    } catch (Exception e) {
        sendSpan.recordException(e); //Span can record exception if any
        sendSpan.setStatus(StatusCode.ERROR, e.getMessage()); //Set span status as ERROR/FAILED
    } finally {
        sendSpan.end(); //End sendSpan. Span data is exported when span.end() is called.
    }
}
</code></pre>
<p>We&#39;ve provided a jar containing the manual implementation code from above, to run the jar and publish messages to the broker, execute the command below from the solace-dt-demo directory.</p>
<pre><code language="language-bash" class="language-bash">java -jar solace-samples-jcsmp-publisher-manual-instrumentation-1.0-SNAPSHOT.jar tcp://localhost:55557 default default default
</code></pre>
<p>After publishing a few messages, stop the jar by pressing <code>[ENTER]</code>.</p>
<p>Navigating back to the Jaeger UI, update the Service filter to <em>SolaceJCSMPManualOpenTelemetry</em>.</p>
<p>We should see our traces from the Publisher as well as the trace from the broker. <img alt="Jaeger10" src="img/2cdd5329c18317e1.png"></p>
<p>Clicking into trace, we can see the span created by <em>SolaceJCSMPPublisherManualInstrumentation</em> with our custom attributes. <img alt="Jaeger11" src="img/d01de646ada9d70f.png"></p>
<p>Next, we&#39;ll take a look at how we can manually implement tracing in the the Queue Subscriber applicaiton.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Manual-instrumentation - Queue Subscriber" duration="10">
        <p>As with the Publisher application, the Queue Subscriber application leverages the Solace <a href="https://docs.solace.com/API/Messaging-APIs/JCSMP-API/jcsmp-api-home.htm" target="_blank">JCSMP API</a> to consume messages from the <code>q</code> queue and the <a href="https://mvnrepository.com/artifact/com.solace/solace-opentelemetry-jcsmp-integration" target="_blank">Solace PubSub+ OpenTelemetry Integration For Solace JCSMP API</a> to enable tracing.</p>
<p>The related file can be found in the following directory from the <a href="https://github.com/TamimiGitHub/solace-dt-demo" target="_blank">solace-dt-demo</a> repo <code>solace-dt-demo/manual-instrumentation/jcsmp-subscriber/src/main/java/com/solace/samples/QueueSubscriber.java</code></p>
<p>With the Queue Subscriber, we add the tracing functionality to the <code>onReceive</code> method of the QueueFlowListen. Again we use the <em>SolaceJCSMPTextMapGetter</em> to extract existing context from the message.</p>
<pre><code language="language-java" class="language-java">final SolaceJCSMPTextMapGetter getter = new SolaceJCSMPTextMapGetter();
final Context extractedContext = JcsmpTracingUtil.openTelemetry.getPropagators().getTextMapPropagator().extract(Context.current(), message, getter);
</code></pre>
<p>Next, we&#39;ll see that the manual implementation has enabled us customized the behavior of the QueueSubscriber to generate a span upon initial reception of the message and after our application has completed app specific processing</p>
<pre><code language="language-java" class="language-java">// Set the extracted context as current context
try (Scope scope = extractedContext.makeCurrent()) {
    //Create a child span and set extracted/current context as parent of this span
    final Span receiveSpan = JcsmpTracingUtil.tracer.spanBuilder(SERVICE_NAME + &#34; &#34; + SpanAttributes.MessagingOperation.RECEIVE).setSpanKind(SpanKind.CLIENT).setAttribute(SpanAttributes.MessagingAttribute.DESTINATION_KIND.toString(), SpanAttributes.MessageDestinationKind.QUEUE.toString()).setAttribute(SpanAttributes.MessagingAttribute.IS_TEMP_DESTINATION.toString(), &#34;false&#34;)
            //Set more attributes as needed
            .setAttribute(&#34;myReceiveKey&#34;, &#34;receiveValue1&#34;)
            //.setAttribute(...)
            .setParent(extractedContext).startSpan();

    //... and then we do processing and have another span
    try {
        final Span processSpan = JcsmpTracingUtil.tracer.spanBuilder(SERVICE_NAME + &#34; &#34; + SpanAttributes.MessagingOperation.PROCESS).setSpanKind(SpanKind.CLIENT)
                //Set more attributes as needed
                .setAttribute(&#34;myProcessingKey&#34;, &#34;postProcessInformation&#34;)
                //.setAttribute(...)
                .setParent(Context.current().with(receiveSpan)) // make RECEIVE span be parent
                .startSpan();
// continued below...
</code></pre>
<p>After creating both the receive and process spans, completing our custom processing, and ACK&#39;ing the message we can go ahead and end our process and receive spans (order is important here!). Only after ending the current span is the data exported to the configured Opentelemetry collector.</p>
<aside class="special"><p>The OpenTelemetry collector is brought in to the application via the <em>opentelemetry-exporter-otlp</em> library. Default settings are used to export to the collector executing in Docker.</p>
</aside>
<pre><code language="language-java" class="language-java">//...continued from above
        try {
            msgRecvCounter++;
            if (message.getRedelivered()) {  // useful check
                // this is the broker telling the consumer that this message has been sent and not ACKed before.
                 // this can happen if an exception is thrown, or the broker restarts, or the network disconnects
                 // perhaps an error in processing? Should do extra checks to avoid duplicate processing
                 hasDetectedRedelivery = true;
            }
             // Messages are removed from the broker queue when the ACK is received.
             // Therefore, DO NOT ACK until all processing/storing of this message is complete.
             // NOTE that messages can be acknowledged from a different thread.
             message.ackMessage();  // ACKs are asynchronous
        } catch (Exception e) {
         processSpan.recordException(e); //Span can record exception if any
         processSpan.setStatus(StatusCode.ERROR, e.getMessage()); //Set span status as ERROR/FAILED
        } finally {
         processSpan.end(); //End processSpan. Span data is exported when span.end() is called.
        }
    } finally {
     receiveSpan.end(); //End receiveSpan. Span data is exported when span.end() is called.
    }
}
</code></pre>
<p>We&#39;ve provided a jar containing the manual implementation code from above, to run the jar and subscribe to the <code>q</code> queue on the broker, execute the command below from the solace-dt-demo directory.</p>
<pre><code language="language-bash" class="language-bash">java -jar solace-samples-jcsmp-subscriber-manual-instrumentation-1.0-SNAPSHOT.jar tcp://localhost:55557 default default default
</code></pre>
<p>After consuming the messages from the queue, stop the jar by pressing <code>[ENTER]</code>.</p>
<p>Back in Jaeger, we can see the new spans added to the existing traces after refreshing the search UI.</p>
<p>We see both the receive and process spans with their respective custom attributes. <img alt="Jaeger13" src="img/5e883fc42d7f4aad.png"></p>
<h2 is-upgraded>More samples</h2>
<p>For more examples on how to use manual instrumentation head to the <a href="https://github.com/SolaceSamples" target="_blank">Solace Samples</a> github org and navigate to the API of choice</p>


      </google-codelab-step>
    
      <google-codelab-step label="Clean-up" duration="2">
        <h2 is-upgraded>Removing created Docker containers</h2>
<p>To tear down Docker containers created in an earlier step, run the following command:</p>
<pre><code language="language-bash" class="language-bash">[solace@dev ~] $ cd solace-dt-demo
[solace@dev solace-dt-demo] $ docker compose down
</code></pre>
<p>To remove Docker images created:</p>
<pre><code language="language-bash" class="language-bash">[solace@dev solace-dt-demo] $ docker image rm &lt;image id&gt;
</code></pre>
<p>To view the list of Docker images, you can run the following command:</p>
<pre><code language="language-bash" class="language-bash">[solace@dev solace-dt-demo]$ docker image ls
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Takeaways" duration="2">
        <p>In this codelab, we went over</p>
<p>✅ Setting up an environment the supports tracing messages in an event driven architecture system using OpenTelemetry and a distributed tracing enabled Solace PubSub+ Event Broker<br> ✅ Used Jaeger as the open source, end-to-end distributed tracing backend to observe our traces<br> ✅ Discussed the differences between Auto and Manual instrumentation instrumentation</p>
<p>Thanks for participating in this codelab! Let us know what you thought in the <a href="https://solace.community/" target="_blank">Solace Community Forum</a>! If you found any issues along the way we&#39;d appreciate it if you&#39;d raise them by clicking the Report a mistake button at the bottom left of this codelab.</p>
<p class="image-container"><img alt="Soly Image Caption" src="img/44f356558033e250.gif"></p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/claat-public/native-shim.js"></script>
  <script src="https://storage.googleapis.com/claat-public/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/claat-public/prettify.js"></script>
  <script src="https://storage.googleapis.com/claat-public/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
